%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------

\chapter{Arquitectura del generador de historias}

\begin{FraseCelebre}
\begin{Frase}
	Comentar el código es como limpiar el cuarto de baño; nadie quiere hacerlo, pero el resultado es siempre una experiencia más agradable para uno mismo y sus invitados
\end{Frase}
\begin{Fuente}
	Ryan Campbell
\end{Fuente}
\end{FraseCelebre}

Al momento de empezar a crear una historia podemos plantearnos diferentes enfoques con el fin de abordar esta cuestión de la manera mas sencilla posible. Para nosotros, el aspecto mas importante de esto son los personajes. Queremos hacer historias que se centren en estos ya que serán estos quienes al momento de interactuar entre si, generarán la historia que deseemos.

Para hacer que existan los personajes dentro del sistema es necesario definirlos y darles las herramientas necesarias para que estos puedan interactuar. Dicho esto, los personajes deben existir dentro del sistema multi-agente.

El SMA es el componente capaz de dotar a los personajes de las herramientas que les permiten enviar mensajes para comunicarse con otros personajes y existir como agentes software. Usando JADE, este sistema nos permite controlar la existencia de los agentes y poder manipularlos como tal.

El siguiente enfoque tiene mas que ver con el aspecto del entorno de la historia. Tener varios personajes en la historia no implica nada si estos no disponen de un entorno sobre el cual desarrollar sus acciones y vivencias. Es necesario ahora otorgar al sistema un poco más de profundidad en el asunto, necesitamos añadir el mundo.

El Mundo, o agente Mundo, es un componente que permitirá a los personajes disponer de un nuevo espacio, un lugar donde queden reflejadas sus acciones. Sin la existencia del Mundo podríamos decir que los personajes viven en la nada, visto de otra forma, es como si todos estuviesen en una habitación vacía, un espacio unidimensional en el cual no tendría sentido realizar acciones como moverse, negociar con terceros personajes, dudar...

La existencia del Mundo como nueva dimensión espacial aporta a los personajes la capacidad de existir en un plano. Los personajes dejan de conocer la situación de otros y llegan a la necesidad de interactuar con su entorno para poder realizar acciones relevantes en una historia.

Ahora que ya tenemos un ecosistema creado con los personajes y su entorno, necesitamos de un sistema capaz de otorgar la lógica o inteligencia a los personajes. Dicho sistema es el planificador. El planificador es el componente que permite a los personajes "pensar" en la secuencia de acciones que deben realizar para poder cumplir sus objetivos dentro de la historia. Estas acciones ayudarán al personaje desde decidir a cual dirección moverse hasta en que momento pelear con otro personaje.

Con todo esto tenemos descrito el núcleo importante de nuestro sistema. Se han juntado los componentes mínimos para poder generar una historia. Aún así, todavía el usuario no está incluido dentro de todo esto, y no tiene sentido tener un sistema que trabaje para sí en lugar de dejarle a un usuario una copia de los resultados obtenidos.

Es necesario el uso de algún componente ó sistema que nos permita recoger el flujo de historia final. Saber cuáles han sido los mensajes que intercambiaron los personajes y las acciones que realizaron. Usar un \textit{logger} nos permite guardar un registro del momento en el que ocurre cada eventos de la historia.

Sin embargo, al ser un sistema pensado para ser utilizado por un usuario, falta disponer de una capa que permita a este interactuar con el sistema. La interfaz gráfica otorga al usuario la capacidad de visualizar información adicional durante el momento de la simulación. Es mediante esta capa, que el usuario puede también añadir nuevos elementos a la generación de historias.

A continuación hablaremos con más detalle sobre cada uno de estos componentes y sobre otras partes del sistema necesarias ó que se ven afectadas por estos.

\newpage
%-------------------------------------------------------------------
\section{Diagrama de la arquitectura}

Para tener una referencia que nos permita visualizar de manera sencilla la arquitectura del proyecto, podemos fijarnos en la figura \ref{fig:ArquitecturaProyecto}.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/arquitectura}
	\caption{Arquitectura del proyecto}
	\label{fig:ArquitecturaProyecto}
\end{figure}

%-------------------------------------------------------------------
\section{Personajes y SMA}
\label{cap:Arquitectura:PersonajesSMA}

Cada uno de los personajes es implementado como agente software usando la plataforma JADE. Esto permite que los personajes puedan usar los estándares definidos por FIPA e interactuar con otros personajes.

Cada agente del sistema es un hilo de ejecución independiente dentro de este. Esto permite que cada uno de los personajes pueda existir y actuar independientemente del resto de agentes.

%Estudiando diferentes tipos de historias, de diferentes autores y temáticas variadas, se puede observar en la gran mayoría de los casos que existe un factor en común para estas historias. Hablamos sobre los arquetipos de personajes que existen en las historias.
%
%Generalmente, por no decir en todas las historias, siempre existe un personaje que es el protagonista, ó varios personajes. Siempre hay una figura contraria, un villano. Suele haber uno o varios personajes que sirven de motivación para que el protagonista se desenvuelva dentro de la historia. Y también hay personajes que si bien no son ``relevantes'' para la historia, de alguna manera y en algún momento interactúan con el protagonista para guiarle o alterar el curso de su historia.
%
%Teniendo muy presente que éste es un factor clave al momento de diseñar un sistema capaz de generar diferentes tipos y temáticas de historias, se plantea la siguiente estructura:
%
%\begin{itemize}
%	\item \textbf{Personaje}.
%	Clase que nos permite modelar las características comunes de todos los agentes. Aspectos como la vida del personaje, localización, sexo, clase de personaje se contemplan en este nivel.
%	
%		\begin{itemize}
%			\item \textbf{Protagonistas}.
%			Son personajes que disponen de atributos especiales (fuerza, inteligencia...) y que tienen la capacidad de usar ciertos objetos. Entre estos personajes disponemos de:
%			
%			\begin{itemize}
%				\item \textbf{Víctima}. Este personaje será objeto de secuestro por parte de uno de los antagonistas.
%				
%				\item \textbf{Salvador}. El principal, el posible héroe, que intentará rescatar a la víctima y dejarla a salvo.
%				
%				\item \textbf{Mentor}. Este personaje es quien se encarga de pedir ayuda al salvador para rescatar a la víctima.
%				
%				\item \textbf{Compañero}. Su labor es ayudar al salvador en los posibles obstáculos que éste encuentre en su travesía.
%				
%				\item \textbf{Especialista}. Un personaje que sabe como lidiar con los ``Cazatesoros'' e inspeccionar la integridad de los objetos de la historia.
%			\end{itemize}
%			
%			\item \textbf{Antagonistas}.
%			Estos son los personajes que se encargarán de poner a prueba las habilidades de los protagonistas, poniendo obstáculos en su camino o intentando eliminarlos. Se proporcionan los siguientes tipos:
%			
%			\begin{itemize}
%				\item \textbf{Secuestrador}. Este personaje se encarga de raptar a la víctima y ocultarla del protagonista.
%				
%				\item \textbf{Emboscador}. El emboscador es un personaje que tratará de impedir el paso a cierto tipo de protagonista. Merodea a través del mapa a la espera de que un protagonista se cruce en su camino.
%				
%				\item \textbf{Guardián}. También puede verse como el ``Cazatesoros''. Es un personaje que va en la búsqueda de algún objeto dentro de la historia.
%				
%				\item \textbf{Asesino}. La representación tácita del mal. Un personaje que busca acabar con la vida de otro.
%			\end{itemize}
%			
%			\item \textbf{Personajes No Jugadores (PNJ's)}. Estos son personajes que no tienen un objetivo que cumplir como tal, pero sirven como generadores de recursos para los protagonistas que se encuentren con ellos.
%			
%		\end{itemize}
%		
%\end{itemize}

En el capítulo \ref{cap:Personajes} se habla con más detalle sobre el trasfondo y características que tiene cada personaje.

Comprender cómo está estructurado el SMA y por qué funciona requiere que se hable con una terminología más técnica y que indaguemos con más profundidad en las prestaciones que nos ofrecen los agentes, JADE y los estándares FIPA.

%http://www.fipa.org/specs/fipa00023/XC00023H.html


\subsection{Modelo del gestor de agentes}
%(ref) explica que e
El gestor de agentes proporciona el framework donde los agentes FIPA existen y operan. Éste establece el modelo lógico de referencia para la creación, registro, localización,comunicación,migración y retiro de los agentes.

Las entidades contenidas en la figura \ref{fig:ModeloReferencia} son una configuración lógica y no implica ninguna configuración física.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/agentmanagementReference}
	\caption{Modelo de referencia del gestor de agentes}
	\label{fig:ModeloReferencia}
\end{figure}

El \textbf{Directory Facilitator (DF)} es un componente esencial del AP(explicado más adelante). El DF proporciona un servicio de \textit{páginas amarillas} para el resto de agentes. Los agentes pueden registar sus servicios en el DF ó consultar éste para conocer que servicios ofrecen otros agentes. La figura \ref{fig:PaginasAmarillas} muestra un ejemplo de este servicio.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/paginasAmarillas}
	\caption{Servicio de páginas amarillas}
	\label{fig:PaginasAmarillas}
\end{figure}

El \textbf{Agent Management System (AMS)} es un componente esencial del AP. El AMS ejerce control de supervisión sobre el acceso y uso del AP. Sólo un AMS debe existir para cada AP. El AMS mantiene un directorio de AIDs (Agent Identifications) que contienen direcciones de transporte (entre otras cosas) para los agentes registrados en el AP. El AMS ofrece un servicio de \textit{páginas blancas} para otros agentes. Cada agente debe registrarse en el AMS para poder obtener un AID válido.

Un \textbf{Message Transport Service (MTS)} es el método de comunicación por defecto entre agentes a través de diferentes APs.

Un \textbf{Agent Platform (AP)} proporciona la infraestructura física donde los agentes son desplegados. La AP comprende la máquina/s, sistema operativo, software de soporte de agentes, componentes de gestión de agentes FIPA (DF, AMS y MTS) y los agentes.

El diseño interno de una AP es labor de los desarrolladores del sistema de agentes y no está sujeto a una estandarización por parte de FIPA. Las APs y los agentes que son nativos a esa AP, ya sea por haber sidos creados ó migrados a esa AP, pueden utilizar cualquier método propio para la comunicación interna entre ellos.

\subsection{Identificación de los agentes}
Es oportuno comentar que para que un agente disponga de AID\footnote{Agent IDentifaction} válido, el nombre usado como identificador al momento de crear un agente ha de ser único dentro del AP. De otra manera el sistema considera que el identificador se encuentra repetido y no será posible registrar correctamente el agente dentro del AP. El nombre identificador no es sensible a mayúsculas ni minúsculas, y es altamente recomendable que no contenga espacios en este para asegurar el correcto funcionamiento del sistema.

\subsection{Ciclo de vida de los agentes}
Un agente FIPA existe físicamente dentro de una AP y usa las facilidades proporcionadas por ésta para ejecutar sus funcionalidades. Dicho esto, el agente posee un ciclo de vida que es controlado por la AP como podemos observar en la figura \ref{fig:CicloVidaAgentes}.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/cicloVidaAgentes}
	\caption{Ciclo de vida de los agentes FIPA}
	\label{fig:CicloVidaAgentes}
\end{figure}

\textbf{Active:} El MTS entrega mensajes al agente con normalidad.

\textbf{Initiated/Waiting/Suspended:} El MTS bien almacena en un buffer los mensajes hasta que el agente vuelva al estado activo ó reenvía los mensajes a una nueva localización (si el reenvío está disponible para el agente)

\textbf{Transit:} El MTS bien almacena en un buffer los mensajes hasta que el agente vuelva a estar activo (eso es, la función mover a fallado en la AP original ó el agente a iniciado satisfactoriamente en la AP destino) ó reenvía los mensajes a una nueva localización (si el reenvío está disponible para el agente). Téngase en cuenta que sólo los agentes móviles pueden entrar en estado de tránsito. Esto asegura que un agente estático ejecuta todas sus instrucciones en el nodo donde fue invocado.


\textbf{Unknown:} El MTS bien almacena en un buffer los mensajes o los rechaza, dependiendo de la política del MTS y de los requerimientos de transporte del mensaje.

Un agente en JADE dispone de 2 métodos fundamentales:
\begin{itemize}
	\item \texttt{setup()}: Método que se invoca al momento que se crea el agente, cuando el agente pasa a los estados de \textit{iniciado} y \textit{activo}. Dentro de este método se especifican las instrucciones y los comportamientos de los que dispondrá el agente.
	
	\item \texttt{takeDown()}: Método invocado automáticamente al momento que se destruye el agente. Principalmente nos permite liberar recursos usados por el agente antes de que deje de existir en la AP. 
\end{itemize}

\subsection{Comportamientos JADE}


Los agentes en JADE se especifican mediante comportamientos. Los comportamientos definen la forma de actuar para cada agente ante un problema dado. Cada comportamiento se encarga de resolver una tarea, comunicarse, o evaluar alguna condición del agente.

Cada agente dispone a su vez de una cola de comportamientos en la cual ser irán incluyendo los comportamientos agregados con \verb|addBehaviour()|. Cuando llega el turno de ejecución de un comportamiento, este intenta realizar su tarea y al finalizar es removido y eliminado de la cola. Existen comportamientos que en función del tipo que sean, al finalizar su tarea intentarán añadirse nuevamente a la cola.

Los tipos de comportamientos en JADE son los siguientes:

\begin{itemize}
	\item \textbf{Behaviour}. Comportamiento básico que proporciona los métodos \verb|action()| \footnote{Dentro se especifican las tareas que va a realizar el comportamiento.} y \verb|done()|\footnote{Devuelve \texttt{true} si el comportamiento ha finalizado su ejecución.}.
	\begin{itemize}
		
			\item \textbf{SimpleBehaviour}. Comportamientos que realizan tarea simples.
			
			\begin{itemize}
				\item \textbf{OneShotBehaviour}. Tipo de comportamiento que su método \verb|action()| se ejecuta una única vez.
				
				\item \textbf{TickerBehaviour}. Comportamiento de ejecución periódica.
				
				\item \textbf{WakerBehaviour}. Es una variación del OneShotBehaviour que inicia su ejecución después de un tiempo especificado.
				
				\item \textbf{CyclicBehaviour}. Comportamiento cuyo método \verb|done()| siempre devuelve \verb|false|, por tanto al terminar su \verb|action()| vuelve a la cola de comportamientos.
				
			\end{itemize}
			
			\item \textbf{CompositeBehaviour}. Nos permite integrar dentro de su estructura múltiples comportamientos.
			
			\begin{itemize}
				
				\item \textbf{ParallelBehaviour}. Este tipo permite la ejecución en paralelo de varios comportamientos.
				
				\item \textbf{SerialBehaviour}. Nos permite representar sucesiones de comportamientos.
				
				\begin{itemize}
					\item \textbf{SequentialBehaviour}. Obliga a los comportamientos que lo integran a ejecutarse en un orden especificado.
					
					\item \textbf{FSMBehaviour}. Nos permite emular una máquina de estados finita basada en comportamientos.
				\end{itemize}
			\end{itemize}
	\end{itemize}
\end{itemize}

La figura \ref{fig:JerarquiaComportamientos} nos muestra un diagrama detallado de los comportamientos en JADE.

\begin{figure}[h]
	\centering
	\includegraphics[width=1\textwidth]{Imagenes/jerarquiaComportamientos}
	\caption{Diagrama de jerarquía de los comportamientos en JADE}
	\label{fig:JerarquiaComportamientos}
\end{figure}

Al momento de diseñar el comportamiento de un agente es probable que se requiera de comportamientos que sean capaces de ejecutarse en paralelo y al mismo tiempo. El tipo ParallelBehaviour hace una ejecución en paralelo de dos ó más comportamientos pero lo que hace realmente es ejecutar un método \texttt{action()} a la vez, del comportamiento que toque, y luego va alternando con los demás comportamientos.

Esto se debe a que el manejo de los comportamientos no sigue una política de expulsión, es decir, cuando se está ejecutando el método \texttt{action()} de un comportamiento éste nunca se ve interrumpido para que otro inicie su ejecución. Sólo cuando ése método termina y devuelve la salida \texttt{done()} como \texttt{true} se otorga el control al \texttt{action()} del siguiente comportamiento en la cola.

JADE ofrece una solución bastante sencilla si necesitamos que dos comportamientos tengan la oportunidad de realmente ejecutarse a la vez, esto es asignando comportamientos a hilos dedicados.

La clase \texttt{ThreadedBehaviourFactory} dispone de un método \texttt{wrap()} que se encarga de encapsular el comportamiento en un hilo dedicado cuando se añade éste a un agente.

Por último, en la figura \ref{fig:DiagramaFlujoAgentes} tenemos un diagrama de flujo que representa el ciclo de ejecución de un agente con sus comportamientos en JADE.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.7\textwidth]{Imagenes/ejecucionAgenteTraducido}
	\caption{Flujo de ejecución de un agente y sus comportamientos en JADE}
	\label{fig:DiagramaFlujoAgentes}
\end{figure}


\subsection{Mensajes FIPA}
\label{cap:Arquitectura:SMA:FIPA}

En el capítulo \ref{cap:EstadoDeLaCuestion} en la tabla \ref{fig:ACLParameters}, hemos visto cuáles son los parámetros que caracterizan a los mensajes FIPA ACL. Cuando los agentes se comunican, identificar el tipo de mensajes que se envían es muy importante de cara al control y tipo de tareas que quieren realizar los agentes. La tabla \ref{fig:Performatives} contiene algunos de los diferentes tipos de comunicación que nos ofrece el campo \texttt{performative}:

\begin{table}[h!]
	\centering
	\begin{tabular}{!{\vrule width 2pt}l!{\vrule width 2pt}l!{\vrule width 2pt}} 
		\noalign{\hrule height 2pt}
		\textbf{Acto comunicativo}		& \textbf{Descripción} \\ 
		\noalign{\hrule height 2pt}
		
		\texttt{Accept Proposal} 	& \parbox[t]{8cm}{La acción de aceptar una propuesta} \\ \hline
		\texttt{Call for Proposal}	& \parbox[t]{8cm}{La acción de hacer propuestas para realizar cierta acción }\\ \hline
		\texttt{Confirm}			& \parbox[t]{8cm}{El emisor informa al receptor que una proposición dada es cierta }\\ \hline
		\texttt{Disconfirm}			& \parbox[t]{8cm}{El emisor informa al receptor que una proposición dada es falsa} \\ \hline
		\texttt{Failure}			& \parbox[t]{8cm}{La acción de indicar a otro agente que se intentó realizar una acción pero este intento falló} \\ \hline
		\texttt{Inform}				& \parbox[t]{8cm}{El emisor informa al receptor que una proposición dada es cierta }\\ \hline
		\texttt{Propose}			& \parbox[t]{8cm}{La acción de enviar una propuesta para realizar cierta acción, dadas ciertas precondiciones} \\ \hline
		\texttt{Refuse}				& \parbox[t]{8cm}{La acción de rehusarse a realizar una acción dada, y explicando la razón por la cual no se realiza la acción }\\ \hline
		\texttt{Reject Proposal}	& \parbox[t]{8cm}{La acción de rechazar la propuesta de realizar cierta acción durante la negociación} \\ \hline
		\texttt{Request}			& \parbox[t]{8cm}{El emisor solicita al receptor a realizar cierta acción. Una importancia de \texttt{Request} es que solicita al receptor realizar otro acto comunicativo }\\ \hline
		
		
		\noalign{\hrule height 2pt}
	\end{tabular}
	\caption{Tipos de actos comunicativos definidos en \texttt{performative}}
	\label{fig:Performatives}
\end{table}

En el cuadro de código \ref{mensajeRequest} podemos ver un ejemplo del contenido de un mensaje usando el acto \texttt{Request}:

%basicstyle=\scriptsize o footnotesize
\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Ejemplo de mensaje FIPA ACL},label=mensajeRequest]
(request
	:sender (agent-identifier :name alice@mydomain.com)
	:receiver (agent-identifier :name bob@yourdomain.com)
	:ontology travel-assistant
	:language FIPA-SL
	:protocol fipa-request
	:content
		""((action
			(agent-identifier :name bob@yourdomain.com)
			(book-hotel :arrival 15/10/2006
						:departure 05/07/2002 ... )
		))""
)
\end{lstlisting}


%-------------------------------------------------------------------
\section{El Agente Mundo}
\label{cap:Arquitectura:AgenteMundo}

Al comienzo de este capítulo se comentó la idea y necesidad de la existencia de un mundo para nuestros personajes. El mundo tiene la función de servir como una plataforma en la cual los personajes se apoyan para poder desarrollar su funcionalidad. Más allá de sólo encargarse de la interacción de los personajes con la escenografía en la que se encuentren, el mundo el encargado de gestionar los siguientes aspectos:

\begin{itemize}
	\item Activar y gestionar las llamadas al SCD (\textit{Sistema de Carga de Datos}). Veremos qué es esto en la sección \ref{cap:Arquitectura:Loaders}.
	\item Actualizar el estado actual de cada personaje.
	\item Gestionar ciertos eventos entre personajes.
	\item Controlar las acciones tomadas contra la interfaz gráfica. Véase más adelante la sección \ref{cap:Arquitectura:InterfazPersonajes}.
	\item Proporcionar a los personajes los archivos necesarios para poder usar el planificador, que veremos en la sección \ref{cap:Arquitectura:Planificador}.
\end{itemize}

Aunque la implementación del mundo se hace como un agente\footnote{Este es un agente especial del tipo GUIAgent, lo que permite la interacción con una interfaz gráfica. Más información de esto la tenemos en \cite{greenwood}.}, debido a la naturaleza de éste, no se considera su pertenencia al SMA.

Al ser un agente, la forma en la que gestiona la mayoría de funciones mencionadas anteriormente es a través de comportamientos JADE. Específicamente usando el tipo CyclicBehaviour. El motivo por el que todos los comportamientos que debe usar este agente sean cíclicos es que principalmente este un agente que debe estar en una escucha continua de peticiones por parte de todos los demás agentes. Por tanto, modelar el funcionamiento de este agente debe hacerse mediante un conjunto de comportamientos que estén constantemente evaluando si se han recibido peticiones nuevas.

Respecto a la interacción con la interfaz, el agente mundo funciona como el controlador al cual la vista envía la información recibida por el usuario y se encarga de validar ésta.

%-------------------------------------------------------------------
\section{El Planificador}
\label{cap:Arquitectura:Planificador}

El planificador es el componente del sistema que se encarga de aportar ``inteligencia'' a los personajes. Recordemos que el propósito de los personajes es resolver un problema y la historia general nos contará lo que ha hecho cada personaje para poder dar solución a sus problemas.

La solución a un problema u objetivo dado al planificador vendrá dada al procesar la información que éste recibe mediante los ficheros de dominio y problema (explicados en la sección \ref{cap:EstadoDeLaCuestion:PDDL}).

Para la generación de historias, el fichero de dominio va a contener el tipo de elementos que existen dentro de estas, las acciones que serán capaces de realizar cada uno de los personajes y alguna otra información clave que indique al planificador cómo actuar. Todo esto significa que es en este fichero donde realmente se le da forma al tipo historia que se desea generar, se definen las características del universo de la historia.

Aquí se presenta gran parte de la complejidad al momento de definir una base para poder generar historias. La calidad y riqueza de cada historia se ve afectada implícitamente por la variedad, complejidad y el nivel de abstracción con el que se programe el dominio. Para tener una idea de todo esto, podemos imaginar que implicaría la creación un \textit{universo} con las siguientes restricciones:

\begin{itemize}
	\item Sólo existen personas, objetos y habitaciones.
	\item Una persona es capaz de cambiar de habitación.
	\item Una persona es capaz de recoger un objeto.
	\item Una persona es capaz de soltar un objeto.
\end{itemize}

Definir un universo tan simple acota la cantidad de permutaciones que se pueden realizar con las acciones, y básicamente habremos creado un universo en el que las personas sólo pueden transportar objetos de una habitación a otra.

Por el contrario, cuanto más se profundiza en las características deseadas dentro del universo que se quiere crear, por ejemplo definiendo aspectos cómo:

\begin{itemize}
	\item Mover pie/brazo derecho/izquierdo, ojo derecho/izquierdo.
	\item Color del pelo, piel y ojos.
	\item Personas, animales, insectos, objetos, paisajes.
	\item Temperatura, altitud, latitud...
	\item Saltar obstáculo pequeño, esquivar obstáculo grande...
\end{itemize} 

Se amplían las herramientas que se pueden usar para dar vida a los personajes y definir una mayor variedad de comportamientos para estos o su entorno si así se desea.

Hay que tener en cuenta que realizar una acción implica el cumplimiento de una serie de precondiciones y efectos especificados en función de la acción. La sucesión de un conjunto de acciones en cierto orden deben asegurar que se consiguen los efectos que hacen cumplir un objetivo dado.

Nótese que esto también conlleva un aumento considerable de la complejidad de los problemas a resolver, y el tiempo que tarda el planificador en poder encontrar una solución plausible a los problemas propuestos.

Por otra parte, el llamado fichero del problema contiene la información del estado actual de las características definidas en el dominio que cada personaje conoce y que, basándose en el estado de estas, saber si existe una solución al problema que intenta resolver.

Usando el ejemplo del universo simple que se comentó antes, el fichero problema contendría por ejemplo la siguiente información:

\begin{itemize}
	\item La habitación \textbf{A} está junto a la \textbf{B}.
	\item El objeto \textbf{X} se encuentra en la habitación \textbf{A}.
	\item La persona \textbf{P} está en la habitación \textbf{B}.
	\item Objetivo de P: \textit{el objeto X debe estar en la habitación B}.
\end{itemize}

Cuando el planificador recibe este fichero problema, lo que hace es buscar en el dominio para saber cuáles son las acciones que \textit{puede} realizar la persona para lograr su objetivo. Una vez evaluadas las diferentes posibilidades, el planificador devuelve el plan de acción (la planificación) que debe llevar a cabo el personaje en estricto orden para conseguir que su objetivo se cumpla. La salida que devolvería el planificador en este caso puede ser algo como lo siguiente:

\begin{enumerate}
	\item Mover P a la habitación A.
	\item Recoger el objeto X.
	\item Mover P a la habitación B.
	\item Soltar el objeto X.
\end{enumerate}

La ejecución ordenada de la planificación devuelta por el planificador asegura (teóricamente) al personaje que logra conseguir con éxito su objetivo.

Los cuadros de código \ref{pddlDomain} y \ref{pddlProblema} nos muestran un ejemplo sencillo de cómo se estructura cada fichero y cómo es la sintaxis de PDDL.

\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Ejemplo de fichero domain.pddl},label=pddlDomain]

(define (domain briefcase-world)
	(:requirements :strips :equality :typing :conditional-effects)
	(:types location physob)
	(:constants (B - physob))
	(:predicates 
		(at ?x - physob ?l - location)
		(in ?x ?y - physob)
	)
	(:action take-out)
		:parameters (?x - physob)
		:precondition (not (= ?x B))
		:effect (not (in ?x)) 
	)
	...
)
\end{lstlisting}


\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Ejemplo de fichero problema.pddl},label=pddlProblema]

(define (problem get-paid)
	(:domain briefcase-world)
	(:init (place home) (place office)
	(object p) (object d) (object b)
	(at B home) (at P home) (at D home) (in P))
	(:goal (and (at B office) (at D office) (at P home)) )
)
\end{lstlisting}


%-------------------------------------------------------------------
\section{Carga de Datos y Archivos de Configuración}
\label{cap:Arquitectura:Loaders}

Además de los archivos pddl usados para la planificación, crear un sistema capaz de permitir al usuario alterar la mayor cantidad de aspectos posible al momento de generar nuevas historias, exige que cierta información del sistema sea configurable fuera de la compilación.

Esta funcionalidad es la que permite al usuario indicar al sistema cuáles son los actores y el entorno donde se van  a generar las diferentes historias y le da la libertad de cambiar los diferentes aspectos que éste hubiese planteado.

Con vistas en esto, el sistema permite al usuario definir y modificar con alta libertad los siguientes aspectos:

\begin{itemize}
	\item Escenografía.
	\item Personajes protagonistas.
	\item Personajes antagonistas.
	\item Frases de los personajes.
	\item Objetivos que han de cumplir los personajes.
	\item Objetos de la historia.
	\item Razas y atributos.
	\item Personajes no jugadores (PNJ's).
\end{itemize}

Estos ficheros están programados en XML\footnote{EXtensible Markup Language}.Este es un lenguaje que nos permite diseñar con mayor simpleza el esquema de los datos que el usuario puede modificar en cada uno de los aspectos que se han mencionado anteriormente. Algunas restricciones, recomendaciones y comentarios generales que influyen en todos los archivos son:

\begin{itemize}
	\item Los atributos \textit{nombreX} deben ser atómicos; una sola palabra.
	\item Los valores numéricos en los atributos, salvo para la vida, mayormente deben estar comprendidos entre 0 y 10.
	\item Es importante la distinción entre mayúsculas y minúsculas para los nombres que se elijan puesto que el sistema en algunos puntos hace distinción de caracteres, y esto puede producir error en el sistema.
	\item Algunos atributos de las etiquetas XML necesariamente tienen que tomar un valor de entre ciertos propuestos.
	\item Aunque se encuentre en dos ficheros diferentes, un mismo nombre es único para todos, por ejemplo en el caso de las localizaciones.
\end{itemize}

El Sistema de Carga de Datos (SCD de ahora en adelante) que se encarga de cargar la información de cada fichero de configuración en el sistema tiene una serie de restricciones específicas para cada uno de estos que se verán con más detalle en los capítulos correspondientes.

%
%
%Para configurar la escenografía se ha diseñado un esquema XML que emulase en cierta manera el aspecto de un mapamundi político. Este diseño nos permite crear múltiples regiones comprendidas por una o más localizaciones. Dejar que el usuario sea omnipotente al momento de configurar el sistema añade un factor de complejidad y coste muy alto al hacer el diseño de todo el sistema generador de historias, así que se decide poner ciertas limitaciones con vistas a mantener un control razonable del sistema mientras se hace diseña. Estas limitaciones se ven reflejadas en los tipos de localizaciones que el usuario puede usar, teniendo este que elegir entre una serie de tipos propuestos predefinidos. El usuario puede usar cualquier nombre desee para las regiones y localizaciones.
%
%El diseño visto en plano de este fichero puede verse como un mapa de adyacencias, esto significa, las conexiones de cada localización representan un camino dirigido en lo que puede ser un grafo. Por tanto, para decir que existe un camino bidireccional entre dos localizaciones es necesario que cada una incluya el nombre de la otra en su etiqueta \textit{conectadoCon}. Dentro de esta etiqueta van separados por espacios los nombres de todas las localizaciones con las que existe un camino A$\rightarrow$B. Tenemos en el cuadro de código \ref{escenografiaXML} el esquema que toma el XML de la escenografía.
%
%\lstset{frameround=fttt}
%\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de la escenografía},label=escenografiaXML]
%
%<?xml version="1.0" encoding="UTF-8"?>
%<Mapa>
%	<region nombre="[nombreRegión]">
%		<localizacion id="[nombreLocalización]" 
%			tipo="[Pueblo|Bosque|Guarida|Urbano|Castillo|Lago]" >
%			
%			<conectadoCon>[nombreLocalización [nombreLocalización ...]]
%				</conectadoCon>
%		</localizacion>    
%	</region>
%</Mapa>
%
%\end{lstlisting}
%
%Siguiendo el patrón que nos ofrece el diseño del archivo de configuración para los protagonistas, añadir multitud de protagonistas a la historia sólo requiere copiar y modificar múltiples instancias de la etiqueta \textit{personaje}. El cuadro de código \ref{protagonistasXML} muestra el diseño que sigue este archivo.
%
%
%\lstset{frameround=fttt}
%\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de los protagonistas},label=protagonistasXML]
%
%<?xml version="1.0" encoding="UTF-8"?>
%<Actores>
%	<personaje nombre="[nombrePersonaje]" clase="[nombreClase]"
%		raza="[nombreRaza]" vida="[#]" 
%			fuerza="[#]" destreza="[#]" inteligencia="[#]" 
%				codicia="[#]"/>
%</Actores>
%\end{lstlisting}
%
%Al igual que en los protagonistas, cada antagonista se define mediante nuevas entradas de la etiqueta \textit{monstruo}. Aquí aparecen ya, atributos cuyo valor debe encontrarse entre los predefinidos, como viene a ser la clase y sexo del antagonista. Esto es para que el sistema pueda tener un mayor control sobre la entrada recibida. El esquema usado se puede ver en el cuadro \ref{antagonistasXML}.
%
%\lstset{frameround=fttt}
%\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de los antagonistas},label=antagonistasXML]
%
%<?xml version="1.0" encoding="UTF-8"?>
%<Actores>
%	<monstruo nombre="[nombreAntagonista]" 
%		clase="[Secuestrador|Guardian|Emboscador|Asesino]"
%			especie="[nombreEspecie]" sexo="[M|F]"/>
%</Actores>
%\end{lstlisting}
%
%La oportunidad de personalizar las frases y la forma de hablar que tiene cada arquetipo de personaje es uno de los aspectos más importantes del sistema. Especificando el arquetipo en \textit{nombreClase} se indica el bloque de frases para ese tipo de personajes. El sistema trata los textos conversacionales en función de ciertos estados para que así el usuario indique las frases que debe usar un arquetipo dependiendo de la situación en la que se encuentre, por ejemplo, las frases que dice cuando está combate, recién se incorpora a la historia ó cambia de localización. Se pueden especificar multitud de frases diferentes para una misma situación, ya que el sistema elije aleatoriamente la frase a decir para cada fase que este atravesando ese personaje. Es importante que estas frases sean impersonales puesto que van a ser usadas por todos los personajes dentro de un mismo arquetipo. El cuadro \ref{frasesXML} nos muestra el esquema de este archivo.
%
%
%\lstset{frameround=fttt}
%\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de las frases de los personajes},label=frasesXML]
%
%<?xml version="1.0" encoding="UTF-8"?>
%<Frases>
%	<personaje tipo="[nombreClase]" >
%		<frase id="[Inicio|Combate...]">[fraseADecir]</frase>
%	</personaje>
%</Frases>
%\end{lstlisting}
%
%El archivo de configuración para objetivos contiene una lista de los posibles objetivos por cada arquetipo de personaje. El sistema se encarga de cargar sólo una de las entradas de la etiqueta \textit{objetivo} cuando necesita completar el archivo del problema para un personaje dado, esto implica que el contenido de la etiqueta debe estar codificado en lenguaje pddl (véase el contenido de \verb|(:goal )|  en el cuadro \ref{pddlProblema} ejemplo del fichero problema). El esquema de este archivo se ve en el cuadro de código \ref{objetivosXML}.
%
%\lstset{frameround=fttt}
%\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de los objetivos},label=objetivosXML]
%
%<?xml version="1.0" encoding="UTF-8"?>
%<Objetivos>
%	<personaje tipo="[nombreClase]" >
%		<objetivo>([códigoPddlObjetivo])</objetivo>
%	</personaje>
%</Objetivos>
%\end{lstlisting}
%\lstset{frameround=fttt}
%
%Siendo quizá un diseño algo diferente a los demás, en el archivo de objetos el sistema diferencia entre 2 tipos de objeto : clave y consumible.
%
%Los objetos clave son aquellos que pueden representar cierta importancia para la historia ó algún personaje, pero que no alteran a los atributos de éste (vida, fuerza...). Un ejemplo de este tipo de objetos es la mítica Excalibur, la espada otorgaría a la persona que la blandiese el título de Rey. Es necesario especificar la localización de cada objeto clave.
%
%Por otra parte, los objetos consumibles generalmente no otorgan tanto juego a la historia ni definen objetivos, pero ayudan a los personajes a evolucionar en el transcurso de la historia. Estos carecen de localización específica puesto se carga un objeto en una localización aleatoria de la escenografía. Los consumibles son capaces de alterar cada uno de los atributos de aquel personaje que los encuentre de forma positiva o negativa dependiendo de cómo se definiesen los valores numéricos de cada objeto en este archivo (los atributos vida, fuerza, etc... pueden tomar valores negativos). El cuadro \ref{objetosXML} muestra el esquema que sigue este archivo.
%
%
%\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de los objetos},label=objetosXML]
%
%<?xml version="1.0" encoding="UTF-8"?>
%<Objetos>
%	<tipo tipo="clave">
%		<objeto nombre="[nombreObjeto]" descripcion="[descripciónObjeto]" 
%			localizacion="[nombreLocalización]"/>
%	</tipo>
%	
%	<tipo tipo="consumible">
%		<objeto nombre="[nombreObjeto]" descripcion="[descripciónObjeto]" 
%			vida="[#]" fuerza="[#]" destreza="[#]" inteligencia="[#]" 
%				codicia="[#]"/>
%	</tipo>
%</Objetos>
%\end{lstlisting}
%
%
%Usando como inspiración juegos de rol del tipo \textit{D\&D}\footnote{Dungeons \& Dragons: Mítico referente de esta familia de juegos.}, el archivo de razas y atributos se diseña para que se parezca a las hojas de razas que se encuentran en los libros del \textit{Game Master}\footnote{Libro que sirve de referencia a la persona guía una partida de D\&D.} pero mucho más simple. Basta definir un nombre de raza e indicar los atributos base modificadores asociados a esa raza.
%
%Este aspecto permite generar diversidad entre personajes de un mismo arquetipo, puesto se puede tener un Caballero más fuerte que otro, una raza que sea más avara y exija cantidades de dinero superiores ó razas más estudiosas que disponen de una mayor inteligencia.
%
%Todos los valores numéricos han de ser necesariamente positivos y preferiblemente no mayores de 10. Esquema en el cuadro \ref{razasXML}.
%
%\lstset{frameround=fttt}
%\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de las razas y atributos},label=razasXML]
%
%<?xml version="1.0" encoding="UTF-8"?>
%<Actores>
%	<raza nombre="[nombreRaza]" vida="[#]" fuerza="[#]" destreza="[#]" 
%		inteligencia="[#]"  codicia="[#]"/>
%</Actores>
%\end{lstlisting}
%
%Por último, añadir personajes al sistema mantiene la simpleza de diseño y agrega un pnj por entrada de la etiqueta \textit{pnj}. Es importante un nombre para la localización válido definido previamente en el archivo de la escenografía. El cuadro \ref{pnjsXML} muestra este esquema.
%
%\lstset{frameround=fttt}
%\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de los PNJ's},label=pnjsXML]
%<?xml version="1.0" encoding="UTF-8"?>
%<Actores>
%	<pnj nombre="[nombrePNJ]" sexo="[M|H]" oficio="[nombreOficio]" 
%		localizacion="[nombreLocalización]"/>
%</Actores>
%\end{lstlisting}


%-------------------------------------------------------------------
\section{Interfaz Gráfica del Sistema}
\label{cap:Arquitectura:InterfazPersonajes}

La inclusión de un módulo que aporta un componente visual al sistema ayuda a incorporar ciertas funcionalidades de una manera sencilla a éste mucho más allá del factor estético.

La figura \ref{fig:Gui} muestra la pantalla principal de la interfaz. Los mensajes producidos por los agentes se muestran en esta pantalla para ir creando el hilo de historia.

\begin{figure}[h]
	\centering
	\includegraphics[width=1\textwidth]{Imagenes/gui}
	\caption{Pantalla principal de la interfaz}
	\label{fig:Gui}
\end{figure}

La barra de menús contiene tres botones que nos permiten interactuar con el sistema:

\begin{itemize}
	\item Personajes: ofrece cuadros de herramientas que permiten incorporar nuevos personajes a la historia.
	\item Mapa: permite seleccionar diferentes imágenes referentes a la escenografía (estas imágenes podemos verlas en el capítulo \ref{cap:Mapa}).
	\item Iniciar: botón que empieza la ejecución de los personajes incorporados usando el cuadro de herramientas.
\end{itemize}

La figura \ref{fig:NuevoPersonaje} es un ejemplo del cuadro de herramientas que permite al usuario agregar nuevos personajes a la historia mientras ésta se está desarrollando.

El usuario puede ir añadiendo personajes continuamente en cualquier momento del transcurso de la historia y todos estos sólo empezarán a ejecutarse cuando se pulse el botón de Iniciar de la pantalla principal. Esto se hace así para dar algo de margen y mantener cierto control a la hora de empezar la ejecución de personajes nuevos.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.3\textwidth]{Imagenes/nuevoPersonaje}
	\caption{Herramienta para incorporar nuevos personajes}
	\label{fig:NuevoPersonaje}
\end{figure}


\newpage
%-------------------------------------------------------------------
\section{El Logger}
\label{cap:Arquitectura:Logger}

Aunque la interfaz gráfica se encarga de mostrar al usuario en momento de ejecución todas las acciones que han llevado a cabo los agentes y que terminan generando la historia, tener un recopilatorio ó registro de todos eventos y las simulaciones realizadas requiere de una parte del sistema que se encargue de registrar todo lo sucedido en un fichero.

Este componente registra toda la información que generan los agentes, incluyendo el emisor del mensaje, el momento de emisión y el mensaje en sí. No obstante, existen ciertos mensajes que no son registrados en el logger ya que restarían claridad al archivo, estos son los mensajes de control que usan los agentes para comunicarse entre ellos, como los visto antes en la sección \ref{cap:Arquitectura:SMA:FIPA}.
