%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------

\chapter{Arquitectura del generador de historias}

\begin{FraseCelebre}
\begin{Frase}
	Comentar el código es como limpiar el cuarto de baño; nadie quiere hacerlo, pero el resultado es siempre una experiencia más agradable para uno mismo y sus invitados
\end{Frase}
\begin{Fuente}
	Ryan Campbell
\end{Fuente}
\end{FraseCelebre}

Al momento de empezar a crear una historia podemos plantearnos diferentes enfoques con el fin de abordar esta cuestión de la manera mas sencilla posible. Para nosotros, el aspecto mas importante de esto son los personajes. Queremos hacer historias que se centren en estos ya que serán estos quienes al momento de interactuar entre si, generarán la historia que deseemos.

Para hacer que existan los personajes dentro del sistema es necesario definirlos y darles las herramientas necesarias para que estos puedan interactuar. Dicho esto, los personajes deben existir dentro del sistema multi-agente.

El SMA es el componente capaz de dotar a los personajes de las herramientas que les permiten enviar mensajes para comunicarse con otros personajes y existir como agentes software. Usando JADE, este sistema nos permite controlar la existencia de los agentes y poder manipularlos como tal.

El siguiente enfoque tiene mas que ver con el aspecto del entorno de la historia. Tener varios personajes en la historia no implica nada si estos no disponen de un entorno sobre el cual desarrollar sus acciones y vivencias. Es necesario ahora otorgar al sistema un poco más de profundidad en el asunto, necesitamos añadir el mundo.

El Mundo, o agente Mundo, es un componente que permitirá a los personajes disponer de un nuevo espacio, un lugar donde queden reflejadas sus acciones. Sin la existencia del Mundo podríamos decir que los personajes viven en la nada, visto de otra forma, es como si todos estuviesen en una habitación vacía, un espacio unidimensional en el cual no tendría sentido realizar acciones como moverse, negociar con terceros personajes, dudar...

La existencia del Mundo como nueva dimensión espacial aporta a los personajes la capacidad de existir en un plano. Los personajes dejan de conocer la situación de otros y llegan a la necesidad de interactuar con su entorno para poder realizar acciones relevantes en una historia.

Ahora que ya tenemos un ecosistema creado con los personajes y su entorno, necesitamos de un sistema capaz de otorgar la lógica o inteligencia a los personajes. Dicho sistema es el planificador. El planificador es el componente que permite a los personajes "pensar" en la secuencia de acciones que deben realizar para poder cumplir sus objetivos dentro de la historia. Estas acciones ayudarán al personaje desde decidir a cual dirección moverse hasta en que momento pelear con otro personaje.

Con todo esto tenemos descrito el núcleo importante de nuestro sistema. Se han juntado los componentes mínimos para poder generar una historia. Aún así, todavía el usuario no está incluido dentro de todo esto, y no tiene sentido tener un sistema que trabaje para sí en lugar de dejarle a un usuario una copia de los resultados obtenidos.

Es necesario el uso de algún componente ó sistema que nos permita recoger el flujo de historia final. Saber cuáles han sido los mensajes que intercambiaron los personajes y las acciones que realizaron. Usar un \textit{logger} nos permite guardar un registro del momento en el que ocurre cada eventos de la historia.

Sin embargo, al ser un sistema pensado para ser utilizado por un usuario, falta disponer de una capa que permita a este interactuar con el sistema. La interfaz gráfica otorga al usuario la capacidad de visualizar información adicional durante el momento de la simulación. Es mediante esta capa, que el usuario puede también añadir nuevos elementos a la generación de historias.

A continuación hablaremos con más detalle sobre cada uno de estos componentes y sobre otras partes del sistema necesarias ó que se ven afectadas por estos.

\newpage
%-------------------------------------------------------------------
\section{Diagrama de la arquitectura}

Para tener una referencia que nos permita visualizar de manera sencilla la arquitectura del proyecto, podemos fijarnos en la figura \ref{fig:ArquitecturaProyecto}.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/arquitectura}
	\caption{Arquitectura del proyecto}
	\label{fig:ArquitecturaProyecto}
\end{figure}

%-------------------------------------------------------------------
\section{Personajes y SMA}
\label{cap:Arquitectura:PersonajesSMA}

Cada uno de los personajes es implementado como agente software usando la plataforma JADE. Esto permite que los personajes puedan usar los estándares definidos por FIPA e interactuar con otros personajes.

Cada agente del sistema es un hilo de ejecución independiente dentro de este. Esto permite que cada uno de los personajes pueda existir y actuar independientemente del resto de agentes.

Estudiando diferentes tipos de historias, de diferentes autores y temáticas variadas, se puede observar en la gran mayoría de los casos que existe un factor en común para estas historias. Hablamos sobre los arquetipos de personajes que existen en las historias.

Generalmente, por no decir en todas las historias, siempre existe un personaje que es el protagonista, ó varios personajes. Siempre hay una figura contraria, un villano. Suele haber uno o varios personajes que sirven de motivación para que el protagonista se desenvuelva dentro de la historia. Y también hay personajes que si bien no son ``relevantes'' para la historia, de alguna manera y en algún momento interactúan con el protagonista para guiarle o alterar el curso de su historia.

Teniendo muy presente que éste es un factor clave al momento de diseñar un sistema capaz de generar diferentes tipos y temáticas de historias, se plantea la siguiente estructura:

\begin{itemize}
	\item \textbf{Personaje}.
	Clase que nos permite modelar las características comunes de todos los agentes. Aspectos como la vida del personaje, localización, sexo, clase de personaje se contemplan en este nivel.
	
		\begin{itemize}
			\item \textbf{Protagonistas}.
			Son personajes que disponen de atributos especiales (fuerza, inteligencia...) y que tienen la capacidad de usar ciertos objetos. Entre estos personajes disponemos de:
			
			\begin{itemize}
				\item \textbf{Víctima}. Este personaje será objeto de secuestro por parte de uno de los antagonistas.
				
				\item \textbf{Salvador}. El principal, el posible héroe, que intentará rescatar a la víctima y dejarla a salvo.
				
				\item \textbf{Mentor}. Este personaje es quien se encarga de pedir ayuda al salvador para rescatar a la víctima.
				
				\item \textbf{Compañero}. Su labor es ayudar al salvador en los posibles obstáculos que éste encuentre en su travesía.
				
				\item \textbf{Especialista}. Un personaje que sabe como lidiar con los ``Cazatesoros'' e inspeccionar la integridad de los objetos de la historia.
			\end{itemize}
			
			\item \textbf{Antagonistas}.
			Estos son los personajes que se encargarán de poner a prueba las habilidades de los protagonistas, poniendo obstáculos en su camino o intentando eliminarlos. Se proporcionan los siguientes tipos:
			
			\begin{itemize}
				\item \textbf{Secuestrador}. Este personaje se encarga de raptar a la víctima y ocultarla del protagonista.
				
				\item \textbf{Emboscador}. El emboscador es un personaje que tratará de impedir el paso a cierto tipo de protagonista. Merodea a través del mapa a la espera de que un protagonista se cruce en su camino.
				
				\item \textbf{Guardián}. También puede verse como el ``Cazatesoros''. Es un personaje que va en la búsqueda de algún objeto dentro de la historia.
				
				\item \textbf{Asesino}. La representación tácita del mal. Un personaje que busca acabar con la vida de otro.
			\end{itemize}
			
			\item \textbf{Personajes No Jugadores (PNJ's)}. Estos son personajes que no tienen un objetivo que cumplir como tal, pero sirven como generadores de recursos para los protagonistas que se encuentren con ellos.
			
		\end{itemize}
		
\end{itemize}

En el capítulo \ref{cap:Personajes} se habla con más detalle sobre el trasfondo y características que tiene cada personaje.

Comprender cómo está estructurado el SMA y por qué funciona requiere que se hable con una terminología más técnica y que indaguemos con más profundidad en las prestaciones que nos ofrecen los agentes, JADE y los estándares FIPA.

http://www.fipa.org/specs/fipa00023/XC00023H.html


\subsection{Modelo del gestor de agentes}
(ref) explica que el gestor de agentes proporciona el framework donde los agentes FIPA existen y operan. Éste establece el modelo lógico de referencia para la creación, registro, localización,comunicación,migración y retiro de los agentes.

Las entidades contenidas en la figura \ref{fig:ModeloReferencia} son una configuración lógica y no implica ninguna configuración física.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/agentmanagementReference}
	\caption{Modelo de referencia del gestor de agentes}
	\label{fig:ModeloReferencia}
\end{figure}

El \textbf{Directory Facilitator (DF)} es un componente esencial del AP. El DF proporciona un servicio de \textit{páginas amarillas} para el resto de agentes. Los agentes pueden registar sus servicios en el DF ó consultar éste para conocer que servicios ofrecen otros agentes. La figura \ref{fig:PaginasAmarillas} muestra un ejemplo de este servicio.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/paginasAmarillas}
	\caption{Servicio de páginas amarillas}
	\label{fig:PaginasAmarillas}
\end{figure}

El \textbf{Agent Management System (AMS)} es un componente esencial del AP. El AMS ejerce control de supervisión sobre el acceso y uso del AP. Sólo un AMS debe existir para cada AP. El AMS mantiene un directorio de AIDs (Agent Identifications) que contienen direcciones de transporte (entre otras cosas) para los agentes registrados en el AP. El AMS ofrece un servicio de \textit{páginas blancas} para otros agentes. Cada agente debe registrarse en el AMS para poder obtener un AID válido.

Un \textbf{Message Transport Service (MTS)} es el método de comunicación por defecto entre agentes a través de diferentes APs.

Un \textbf{Agent Platform (AP)} proporciona la infraestructura física donde los agentes son desplegados. La AP comprende la máquina/s, sistema operativo, software de soporte de agentes, componentes de gestión de agentes FIPA (DF, AMS y MTS) y los agentes.

El diseño interno de una AP es labor de los desarrolladores del sistema de agentes y no está sujeto a una estandarización por parte de FIPA. Las APs y los agentes que son nativos a esa AP, ya sea por haber sidos creados ó migrados a esa AP, pueden utilizar cualquier método propio para la comunicación interna entre ellos.

\subsection{Identificación de los agentes}
Es oportuno comentar que para que un agente disponga de AID válido, el nombre usado como identificador al momento de crear un agente ha de ser único dentro del AP. De otra manera el sistema considera que el identificador se encuentra repetido y no será posible registrar correctamente el agente dentro del AP. El nombre identificador no es sensible a mayúsculas ni minúsculas, y es altamente recomendable que no contenga espacios en este para asegurar el correcto funcionamiento del sistema.

\subsection{Ciclo de vida de los agentes}
Un agente FIPA existe físicamente dentro de una AP y usa las facilidades proporcionadas por ésta para ejecutar sus funcionalidades. Dicho esto, el agente posee un ciclo de vida que es controlado por la AP como podemos observar en la figura \ref{fig:CicloVidaAgentes}.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/cicloVidaAgentes}
	\caption{Ciclo de vida de los agentes FIPA}
	\label{fig:CicloVidaAgentes}
\end{figure}

\textbf{Active:} El MTS entrega mensajes al agente con normalidad.

\textbf{Initiated/Waiting/Suspended:} El MTS bien almacena en un buffer los mensajes hasta que el agente vuelva al estado activo ó reenvía los mensajes a una nueva localización (si el reenvío está disponible para el agente)

\textbf{Transit:} El MTS bien almacena en un buffer los mensajes hasta que el agente vuelva a estar activo (eso es, la función mover a fallado en la AP original ó el agente a iniciado satisfactoriamente en la AP destino) ó reenvía los mensajes a una nueva localización (si el reenvío está disponible para el agente). Téngase en cuenta que sólo los agentes móviles pueden entrar en estado de tránsito. Esto asegura que un agente estático ejecuta todas sus instrucciones en el nodo donde fue invocado.


\textbf{Unknown:} El MTS bien almacena en un buffer los mensajes o los rechaza, dependiendo de la política del MTS y de los requerimientos de transporte del mensaje.

Un agente en JADE dispone de 2 métodos fundamentales:
\begin{itemize}
	\item \texttt{setup()}: Método que se invoca al momento que se crea el agente, cuando el agente pasa a los estados de \textit{iniciado} y \textit{activo}. Dentro de este método se especifican las instrucciones y los comportamientos de los que dispondrá el agente.
	
	\item \texttt{takeDown()}: Método invocado automáticamente al momento que se destruye el agente. Principalmente nos permite liberar recursos usados por el agente antes de que deje de existir en la AP. 
\end{itemize}

\subsection{Comportamientos JADE}


Los agentes en JADE se especifican mediante comportamientos. Los comportamientos definen la forma de actuar para cada agente ante un problema dado. Cada comportamiento se encarga de resolver una tarea, comunicarse, o evaluar alguna condición del agente.

Cada agente dispone a su vez de una cola de comportamientos en la cual ser irán incluyendo los comportamientos agregados con \verb|addBehaviour()|. Cuando llega el turno de ejecución de un comportamiento, este intenta realizar su tarea y al finalizar es removido y eliminado de la cola. Existen comportamientos que en función del tipo que sean, al finalizar su tarea intentarán añadirse nuevamente a la cola.

Los tipos de comportamientos en JADE son los siguientes:

\begin{itemize}
	\item \textbf{Behaviour}. Comportamiento básico que proporciona los métodos \verb|action()| \footnote{Dentro se especifican las tareas que va a realizar el comportamiento.} y \verb|done()|\footnote{Devuelve \texttt{true} si el comportamiento ha finalizado su ejecución.}.
	\begin{itemize}
		
			\item \textbf{SimpleBehaviour}. Comportamientos que realizan tarea simples.
			
			\begin{itemize}
				\item \textbf{OneShotBehaviour}. Tipo de comportamiento que su método \verb|action()| se ejecuta una única vez.
				
				\item \textbf{TickerBehaviour}. Comportamiento de ejecución periódica.
				
				\item \textbf{WakerBehaviour}. Es una variación del OneShotBehaviour que inicia su ejecución después de un tiempo especificado.
				
				\item \textbf{CyclicBehaviour}. Comportamiento cuyo método \verb|done()| siempre devuelve \verb|false|, por tanto al terminar su \verb|action()| vuelve a la cola de comportamientos.
				
			\end{itemize}
			
			\item \textbf{CompositeBehaviour}. Nos permite integrar dentro de su estructura múltiples comportamientos.
			
			\begin{itemize}
				
				\item \textbf{ParallelBehaviour}. Este tipo permite la ejecución en paralelo de varios comportamientos.
				
				\item \textbf{SerialBehaviour}. Nos permite representar sucesiones de comportamientos.
				
				\begin{itemize}
					\item \textbf{SequentialBehaviour}. Obliga a los comportamientos que lo integran a ejecutarse en un orden especificado.
					
					\item \textbf{FSMBehaviour}. Nos permite emular una máquina de estados finita basada en comportamientos.
				\end{itemize}
			\end{itemize}
	\end{itemize}
\end{itemize}

La figura \ref{fig:JerarquiaComportamientos} nos muestra un diagrama detallado de los comportamientos en JADE.

\begin{figure}[h]
	\centering
	\includegraphics[width=1\textwidth]{Imagenes/jerarquiaComportamientos}
	\caption{Diagrama de jerarquía de los comportamientos en JADE}
	\label{fig:JerarquiaComportamientos}
\end{figure}

Por último, en la figura \ref{fig:DiagramaFlujoAgentes} tenemos un diagrama de flujo que representa el ciclo de ejecución de un agente con sus comportamientos en JADE.

\begin{figure}[h]
	\centering
	\includegraphics[width=1\textwidth]{Imagenes/ejecucionAgenteTraducido}
	\caption{Flujo de ejecución de un agente y sus comportamientos en JADE}
	\label{fig:DiagramaFlujoAgentes}
\end{figure}


\subsection{Mensajes FIPA}
En el capítulo \ref{cap:EstadoDeLaCuestion} en la tabla \ref{fig:ACLParameters}, hemos visto cuáles son los parámetros que caracterizan a los mensajes FIPA ACL. Cuando los agentes se comunican, identificar el tipo de mensajes que se envían es muy importante de cara al control y tipo de tareas que quieren realizar los agentes. La tabla \ref{fig:Performatives} contiene algunos de los diferentes tipos de comunicación que nos ofrece el campo \texttt{performative}:

\begin{table}[h!]
	\centering
	\begin{tabular}{!{\vrule width 2pt}l!{\vrule width 2pt}l!{\vrule width 2pt}} 
		\noalign{\hrule height 2pt}
		\textbf{Acto comunicativo}		& \textbf{Descripción} \\ 
		\noalign{\hrule height 2pt}
		
		\texttt{Accept Proposal} 	& \parbox[t]{8cm}{La acción de aceptar una propuesta} \\ \hline
		\texttt{Call for Proposal}	& \parbox[t]{8cm}{La acción de hacer propuestas para realizar cierta acción }\\ \hline
		\texttt{Confirm}			& \parbox[t]{8cm}{El emisor informa al receptor que una proposición dada es cierta }\\ \hline
		\texttt{Disconfirm}			& \parbox[t]{8cm}{El emisor informa al receptor que una proposición dada es falsa} \\ \hline
		\texttt{Failure}			& \parbox[t]{8cm}{La acción de indicar a otro agente que se intentó realizar una acción pero este intento falló} \\ \hline
		\texttt{Inform}				& \parbox[t]{8cm}{El emisor informa al receptor que una proposición dada es cierta }\\ \hline
		\texttt{Propose}			& \parbox[t]{8cm}{La acción de enviar una propuesta para realizar cierta acción, dadas ciertas precondiciones} \\ \hline
		\texttt{Refuse}				& \parbox[t]{8cm}{La acción de rehusarse a realizar una acción dada, y explicando la razón por la cual no se realiza la acción }\\ \hline
		\texttt{Reject Proposal}	& \parbox[t]{8cm}{La acción de rechazar la propuesta de realizar cierta acción durante la negociación} \\ \hline
		\texttt{Request}			& \parbox[t]{8cm}{El emisor solicita al receptor a realizar cierta acción. Una importancia de \texttt{Request} es que solicita al receptor realizar otro acto comunicativo }\\ \hline
		
		
		\noalign{\hrule height 2pt}
	\end{tabular}
	\caption{Tipos de actos comunicativos definidos en \texttt{performative}}
	\label{fig:Performatives}
\end{table}

En el fragmento de código \ref{mensajeRequest} podemos ver un ejemplo del contenido de un mensaje usando el acto \texttt{Request}:

%basicstyle=\scriptsize o footnotesize
\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Ejemplo de mensaje FIPA ACL},label=mensajeRequest]
(request
	:sender (agent-identifier :name alice@mydomain.com)
	:receiver (agent-identifier :name bob@yourdomain.com)
	:ontology travel-assistant
	:language FIPA-SL
	:protocol fipa-request
	:content
		""((action
			(agent-identifier :name bob@yourdomain.com)
			(book-hotel :arrival 15/10/2006
						:departure 05/07/2002 ... )
		))""
)
\end{lstlisting}


%-------------------------------------------------------------------
\section{El Agente Mundo}
\label{cap:Arquitectura:AgenteMundo}

Al comienzo de este capítulo se comentó la idea y necesidad de la existencia de un mundo para nuestros personajes. El mundo tiene la función de servir como una plataforma en la cual los personajes se apoyan para poder desarrollar su funcionalidad. Más allá de sólo encargarse de la interacción de los personajes con la escenografía en la que se encuentren, el mundo el encargado de gestionar los siguientes aspectos:

\begin{itemize}
	\item Activar y gestionar las llamadas al SCD (\textit{Sistema de Carga de Datos}). Veremos qué es esto en la sección \ref{cap:Arquitectura:Loaders}.
	\item Actualizar el estado actual de cada personaje.
	\item Gestionar ciertos eventos entre personajes.
	\item Controlar las acciones tomadas contra la interfaz gráfica. Véase más adelante la sección \ref{cap:Arquitectura:InterfazPersonajes}.
	\item Proporcionar a los personajes los archivos necesarios para poder usar el planificador, que veremos en la sección \ref{cap:Arquitectura:Planificador}.
\end{itemize}

Aunque la implementación del mundo se hace como un agente\footnote{Este es un agente especial del tipo GUIAgent, lo que permite la interacción con una interfaz gráfica. Más información de esto la tenemos en \cite{greenwood}.}, debido a la naturaleza de éste, no se considera su pertenencia al SMA.

Al ser un agente, la forma en la que gestiona la mayoría de funciones mencionadas anteriormente es a través de comportamientos JADE. Específicamente usando el tipo CyclicBehaviour. El motivo por el que todos los comportamientos que debe usar este agente sean cíclicos es que principalmente este un agente que debe estar en una escucha continua de peticiones por parte de todos los demás agentes. Por tanto, modelar el funcionamiento de este agente debe hacerse mediante un conjunto de comportamientos que estén constantemente evaluando si se han recibido peticiones nuevas.

Respecto a la interacción con la interfaz, el agente mundo funciona como el controlador al cual la vista envía la información recibida por el usuario y se encarga de validar ésta.

%-------------------------------------------------------------------
\section{El Planificador}
\label{cap:Arquitectura:Planificador}

El planificador es el componente del sistema que se encarga de aportar inteligencia a los personajes. Recordemos que la intención de los personajes es resolver un problema y la historia general nos contará lo que ha hecho cada personaje para poder dar solución a sus problemas.

La solución a un problema u objetivo dado al planificador vendrá dada por la información es éste recibe mediante los ficheros de dominio y problema (explicados en el capítulo )

%-------------------------------------------------------------------
\section{Sistema de Carga de Datos}
\label{cap:Arquitectura:Loaders}

%-------------------------------------------------------------------
\section{Interfaz Gráfica del Sistema}
\label{cap:Arquitectura:InterfazPersonajes}

%-------------------------------------------------------------------
\section{El Logger}
\label{cap:Arquitectura:Logger}

%-------------------------------------------------------------------
\section{Archivos de Configuración}
\label{cap:Arquitectura:ArchivosXML}
