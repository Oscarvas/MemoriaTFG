%---------------------------------------------------------------------
%
%                          Capítulo 4
%
%---------------------------------------------------------------------

\chapter{Arquitectura del generador de historias}

\begin{FraseCelebre}
\begin{Frase}
	Comentar el código es como limpiar el cuarto de baño; nadie quiere hacerlo, pero el resultado es siempre una experiencia más agradable para uno mismo y sus invitados
\end{Frase}
\begin{Fuente}
	Ryan Campbell
\end{Fuente}
\end{FraseCelebre}

Al momento de empezar a crear una historia podemos plantearnos diferentes enfoques con el fin de abordar esta cuestión de la manera mas sencilla posible. El aspecto sobre el que van a estar centradas las historias generadas son los personajes. Ya que serán estos quienes al momento de interactuar entre sí generarán la historia que se desea.

Para hacer que existan los personajes dentro del sistema es necesario definirlos y darles las herramientas necesarias para que estos puedan interactuar. Dicho esto, los personajes deben existir dentro del Sistema Multi-Agente. El SMA es el componente capaz de dotar a los personajes de las herramientas que les permiten enviar mensajes para comunicarse con otros personajes y existir como agentes software. Usando JADE\footnote{http://jade.tilab.com/}, este sistema permite controlar la existencia de los agentes y poder manipularlos como tal.

El siguiente enfoque tiene más que ver con el aspecto del entorno de la historia. Tener varios personajes en la historia no implica nada si estos no disponen de un entorno sobre el cual desarrollar sus acciones y vivencias. Es necesario ahora otorgar al sistema un poco más de profundidad en el asunto, por lo que se añade un mundo.

El Mundo es un componente que permite a los personajes disponer de un nuevo espacio, un lugar donde queden reflejadas sus acciones. Sin la existencia del Mundo se podría decir que los personajes viven en la nada. Visto de otra forma, es como si todos estuviesen en una habitación vacía, en un espacio unidimensional en el cual no tendría sentido realizar acciones como moverse, negociar con terceros personajes, dudar, etcétera. La existencia del Mundo como nueva dimensión espacial aporta a los personajes la capacidad de existir en un plano. Los personajes dejan de conocer la situación de otros y llegan a la necesidad de interactuar con su entorno para poder realizar acciones relevantes en una historia.

Ahora que ya se tiene un ecosistema creado con los personajes y su entorno, se necesita de un sistema capaz de otorgar la lógica e inteligencia a los personajes, dicho sistema es el planificador. El planificador es el componente que permite a los personajes ``pensar'' en la secuencia de acciones que deben realizar para poder cumplir sus objetivos dentro de la historia. Estas acciones ayudarán al personaje desde decidir a cual dirección moverse hasta en qué momento pelear con otro personaje.

Descrito el núcleo importante del sistema, se han juntado los componentes mínimos para poder generar una historia. Aún así el usuario no está incluido dentro de todo esto y no tiene sentido tener un sistema que trabaje para sí en lugar de dejarle a un usuario una copia de los resultados obtenidos.

Es necesario el uso de algún componente o sistema que nos permita recoger el flujo de historia final. Saber cuáles han sido los mensajes que intercambiaron los personajes y las acciones que realizaron. Usar un \textit{logger} permite guardar un registro del momento en el que ocurre cada eventos de la historia.

Sin embargo, al ser un sistema pensado para ser utilizado por un usuario, falta disponer de una capa que permita a este interactuar con el sistema. La interfaz gráfica otorga al usuario la capacidad de visualizar información adicional durante el momento de la simulación. Es mediante esta capa, que el usuario puede también añadir nuevos elementos a la generación de historias.

A continuación hablaremos con más detalle sobre cada uno de estos componentes y sobre otras partes del sistema necesarias o que se ven afectadas por estos.

Para tener una referencia que permita visualizar de manera sencilla la arquitectura del proyecto se ha incluido la Figura \ref{fig:ArquitecturaProyecto}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=1\textwidth]{Imagenes/EstructuraCompleta_DiagramaDeObjeto1}
	\caption{Arquitectura del proyecto}
	\label{fig:ArquitecturaProyecto}
\end{figure}

%-------------------------------------------------------------------

\newpage
\section{Personajes y SMA}
\label{cap:Arquitectura:PersonajesSMA}

En el Capítulo \ref{cap:EstadoDeLaCuestion:Agentes} se habla extensamente de las partes principales que componen al SMA de la aplicación, JADE y la plataforma que nos ofrece FIPA.

Cada uno de los personajes es implementado como agente software usando la plataforma JADE. Esto permite que los personajes puedan usar los estándares definidos por FIPA e interactuar con otros personajes.

Cada Agente del sistema es un hilo de ejecución independiente dentro de este. Esto permite que cada uno de los personajes pueda existir y actuar independientemente del resto de agentes haciendo uso de los diferentes \textit{behaviours} JADE. La unión de estas herramientas compone el núcleo SMA.



%Estudiando diferentes tipos de historias, de diferentes autores y temáticas variadas, se puede observar en la gran mayoría de los casos que existe un factor en común para estas historias. Hablamos sobre los arquetipos de personajes que existen en las historias.
%
%Generalmente, por no decir en todas las historias, siempre existe un personaje que es el protagonista, ó varios personajes. Siempre hay una figura contraria, un villano. Suele haber uno o varios personajes que sirven de motivación para que el protagonista se desenvuelva dentro de la historia. Y también hay personajes que si bien no son ``relevantes'' para la historia, de alguna manera y en algún momento interactúan con el protagonista para guiarle o alterar el curso de su historia.
%
%Teniendo muy presente que éste es un factor clave al momento de diseñar un sistema capaz de generar diferentes tipos y temáticas de historias, se plantea la siguiente estructura:
%
%\begin{itemize}
%	\item \textbf{Personaje}.
%	Clase que nos permite modelar las características comunes de todos los agentes. Aspectos como la vida del personaje, localización, sexo, clase de personaje se contemplan en este nivel.
%	
%		\begin{itemize}
%			\item \textbf{Protagonistas}.
%			Son personajes que disponen de atributos especiales (fuerza, inteligencia...) y que tienen la capacidad de usar ciertos objetos. Entre estos personajes disponemos de:
%			
%			\begin{itemize}
%				\item \textbf{Víctima}. Este personaje será objeto de secuestro por parte de uno de los antagonistas.
%				
%				\item \textbf{Salvador}. El principal, el posible héroe, que intentará rescatar a la víctima y dejarla a salvo.
%				
%				\item \textbf{Mentor}. Este personaje es quien se encarga de pedir ayuda al salvador para rescatar a la víctima.
%				
%				\item \textbf{Compañero}. Su labor es ayudar al salvador en los posibles obstáculos que éste encuentre en su travesía.
%				
%				\item \textbf{Especialista}. Un personaje que sabe como lidiar con los ``Cazatesoros'' e inspeccionar la integridad de los objetos de la historia.
%			\end{itemize}
%			
%			\item \textbf{Antagonistas}.
%			Estos son los personajes que se encargarán de poner a prueba las habilidades de los protagonistas, poniendo obstáculos en su camino o intentando eliminarlos. Se proporcionan los siguientes tipos:
%			
%			\begin{itemize}
%				\item \textbf{Secuestrador}. Este personaje se encarga de raptar a la víctima y ocultarla del protagonista.
%				
%				\item \textbf{Emboscador}. El emboscador es un personaje que tratará de impedir el paso a cierto tipo de protagonista. Merodea a través del mapa a la espera de que un protagonista se cruce en su camino.
%				
%				\item \textbf{Guardián}. También puede verse como el ``Cazatesoros''. Es un personaje que va en la búsqueda de algún objeto dentro de la historia.
%				
%				\item \textbf{Asesino}. La representación tácita del mal. Un personaje que busca acabar con la vida de otro.
%			\end{itemize}
%			
%			\item \textbf{Personajes No Jugadores (PNJ's)}. Estos son personajes que no tienen un objetivo que cumplir como tal, pero sirven como generadores de recursos para los protagonistas que se encuentren con ellos.
%			
%		\end{itemize}
%		
%\end{itemize}

%En el Capítulo \ref{cap:Personajes} se habla con más detalle sobre el trasfondo y características que tiene cada personaje.

%Comprender cómo está estructurado el SMA y por qué funciona requiere que se hable con una terminología más técnica e indagar con más profundidad en las prestaciones que ofrecen los agentes, JADE y los estándares FIPA.

%http://www.fipa.org/specs/fipa00023/XC00023H.html



%-------------------------------------------------------------------
\section{El Agente Mundo}
\label{cap:Arquitectura:AgenteMundo}

%Al comienzo de este capítulo se comentó la idea y necesidad de la existencia de un mundo para nuestros personajes.
El Agente Mundo tiene la función de servir como una plataforma en la cual los personajes se apoyan para poder desarrollar su funcionalidad. Más allá de sólo encargarse de la interacción de los personajes con la escenografía, el Mundo es el encargado de gestionar los siguientes aspectos:

\begin{itemize}
	\item Activar y gestionar las llamadas al SCD (\textit{Sistema de Carga de Datos}). Ver en la Sección \ref{cap:Arquitectura:Loaders}.
	\item Actualizar el estado actual de cada personaje.
	\item Gestionar ciertos eventos entre personajes.
	\item Controlar las acciones tomadas contra la interfaz gráfica. Véase más adelante la Sección \ref{cap:Arquitectura:InterfazPersonajes}.
	\item Proporcionar a los personajes los archivos necesarios para poder usar el planificador(Sección \ref{cap:Arquitectura:Planificador}).
\end{itemize}

Aunque la implementación del Mundo se hace como un Agente\footnote{Este es un agente especial del tipo GUIAgent, lo que permite la interacción con una interfaz gráfica. Más información en \cite{greenwood}.}, debido a la naturaleza de éste no se considera su pertenencia al SMA.

Respecto a la interacción con la interfaz, el Agente Mundo funciona como el controlador al cual la vista envía la información recibida por el usuario y se encarga de validar ésta.

Al ser un Agente, la forma en la que gestiona la mayoría de funciones mencionadas anteriormente es a través de comportamientos JADE. Específicamente usando el tipo CyclicBehaviour. El motivo por el que todos los comportamientos que debe usar este Agente sean cíclicos es que principalmente este Agente que debe estar en una escucha continua de peticiones por parte de todos los demás Agentes. Por tanto, modelar el funcionamiento de este Agente debe hacerse mediante un conjunto de comportamientos que estén constantemente evaluando si se han recibido peticiones nuevas.
Todo esto se puede ver la arquitectura de clases del Agente Mundo (ver Figura \ref{fig:DCMundo}).

\begin{figure}[h]
	\centering
	\includegraphics[width=0.9\textwidth]{Imagenes/ModelosGeneradorHistorias_DiagramaDeClaseMundo}
	\caption{Diagrama de Clase del Agente Mundo}
	\label{fig:DCMundo}
\end{figure}

%-------------------------------------------------------------------
\section{El Planificador}
\label{cap:Arquitectura:Planificador}

El planificador es el componente del sistema que se encarga de aportar ``inteligencia'' a los personajes. Recordar que el propósito de los personajes es resolver un problema y la historia general contará lo que ha hecho cada personaje para poder dar solución a sus problemas.

La solución a un problema u objetivo dado al planificador vendrá dada al procesar la información que éste recibe mediante los ficheros de dominio y problema (explicados en el Capítulo \ref{cap:EstadoDeLaCuestion:PDDL}).

Para la generación de historias, el fichero de dominio va a contener el tipo de elementos que existen dentro de estas, las acciones que serán capaces de realizar cada uno de los personajes y alguna otra información clave que indique al planificador cómo actuar. Todo esto significa que es en este fichero donde realmente se le da forma al tipo historia que se desea generar, se definen las características del universo de la historia.

Aquí se presenta gran parte de la complejidad al momento de definir una base para poder generar historias. La calidad y riqueza de cada historia se ve afectada implícitamente por la variedad, complejidad y el nivel de abstracción con el que se programe el dominio. Para tener una idea de todo esto, podemos imaginar que implicaría la creación un \textit{universo} con las siguientes restricciones:

\begin{itemize}
	\item Sólo existen personas, objetos y habitaciones.
	\item Una persona es capaz de cambiar de habitación.
	\item Una persona es capaz de recoger un objeto.
	\item Una persona es capaz de soltar un objeto.
\end{itemize}

Definir un universo tan simple acota la cantidad de permutaciones que se pueden realizar con las acciones, y básicamente se habrá creado un universo en el que las personas sólo pueden transportar objetos de una habitación a otra.

Por el contrario, cuanto más se profundiza en las características deseadas dentro del universo que se quiere crear, por ejemplo definiendo aspectos cómo:

\begin{itemize}
	\item Mover pie/brazo derecho/izquierdo, ojo derecho/izquierdo.
	\item Saltar obstáculo pequeño, esquivar obstáculo grande.
	\item Personas, animales, insectos, objetos, paisajes.
	\item Temperatura, altitud, latitud.	
	\item Color del pelo, piel y ojos.
	\item Personalidad.
\end{itemize} 

Se amplían las herramientas que se pueden usar para dar vida a los personajes y definir una mayor variedad de comportamientos para estos o su entorno si así se desea.

Hay que tener en cuenta que realizar una acción implica el cumplimiento de una serie de precondiciones y efectos especificados en función de la acción. La sucesión de un conjunto de acciones en cierto orden deben asegurar que se consiguen los efectos que hacen cumplir un objetivo dado. Nótese que esto también conlleva un aumento considerable de la complejidad de los problemas a resolver y al tiempo que tarda el planificador en poder encontrar una solución plausible a los problemas propuestos.

Por otra parte, el llamado fichero del problema contiene la información del estado actual de las características definidas en el dominio que cada personaje conoce y que, basándose en el estado de estas, sabe si existe una solución al problema que intenta resolver. Usando el ejemplo del universo simple que se comentó anteriormente, el fichero del problema contendría por ejemplo la siguiente información:

\begin{itemize}
	\item La habitación \textbf{A} está junto a la \textbf{B}.
	\item El objeto \textbf{X} se encuentra en la habitación \textbf{A}.
	\item La persona \textbf{P} está en la habitación \textbf{B}.
	\item Objetivo de P: \textit{el objeto X debe estar en la habitación B}.
\end{itemize}

Cuando el planificador recibe este fichero problema, lo que hace es buscar en el dominio para saber cuáles son las acciones que \textit{puede} realizar la persona para lograr su objetivo. Una vez evaluadas las diferentes posibilidades, el planificador devuelve el plan de acción (la planificación) que debe llevar a cabo el personaje en estricto orden para conseguir que su objetivo se cumpla. La salida que devolvería el planificador en este caso sería algo como lo siguiente:

\begin{enumerate}
	\item Mover P a la habitación A.
	\item Recoger el objeto X.
	\item Mover P a la habitación B.
	\item Soltar el objeto X.
\end{enumerate}

La ejecución ordenada de la planificación devuelta por el planificador asegura al personaje que logra conseguir con éxito su objetivo. Los cuadros de Código \ref{pddlDomain} y \ref{pddlProblema}\footnote{Recuperados de \cite{greenwood}} muestran un ejemplo sencillo de cómo se estructura cada fichero y cómo es la sintaxis de PDDL.\newline

\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Ejemplo de fichero domain.pddl},label=pddlDomain]

(define (domain briefcase-world)
	(:requirements :strips :equality :typing :conditional-effects)
	(:types location physob)
	(:constants (B - physob))
	(:predicates 
		(at ?x - physob ?l - location)
		(in ?x ?y - physob)
	)
	(:action take-out)
		:parameters (?x - physob)
		:precondition (not (= ?x B))
		:effect (not (in ?x)) 
	)
	...
)
\end{lstlisting}


\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Ejemplo de fichero problema.pddl},label=pddlProblema]

(define (problem get-paid)
	(:domain briefcase-world)
	(:init (place home) (place office)
	(object p) (object d) (object b)
	(at B home) (at P home) (at D home) (in P))
	(:goal (and (at B office) (at D office) (at P home)) )
)
\end{lstlisting}


%-------------------------------------------------------------------
\section{Carga de Datos y Archivos de Configuración}
\label{cap:Arquitectura:Loaders}

Además de los archivos pddl usados para la planificación, crear un sistema capaz de permitir al usuario alterar la mayor cantidad de aspectos posible al momento de generar nuevas historias, exige que cierta información del sistema sea configurable fuera de la compilación.

Esta funcionalidad es la que permite al usuario indicar al sistema cuáles son los actores y el entorno donde se van  a generar las diferentes historias y le da la libertad de cambiar los diferentes aspectos que éste hubiese planteado.

Con vistas en esto, el sistema permite al usuario definir y modificar con alta libertad los siguientes aspectos:

\begin{itemize}
	\item Escenografía.
	\item Personajes protagonistas.
	\item Personajes antagonistas.
	\item Frases de los personajes.
	\item Objetivos que han de cumplir los personajes.
	\item Objetos de la historia.
	\item Razas y atributos.
	\item Personajes no jugadores (PNJ's).
\end{itemize}

Estos ficheros están codificados en XML\footnote{eXtensible Markup Language}. Este es un lenguaje que nos permite diseñar con mayor simpleza el esquema de los datos que el usuario puede modificar en cada uno de los aspectos que se han mencionado anteriormente. Algunas restricciones, recomendaciones y comentarios generales que influyen en todos los archivos son:

\begin{itemize}
	\item Los atributos \textit{nombreX} deben ser atómicos; una sola palabra.
	\item Los valores numéricos en los atributos, salvo para la vida, mayormente deben estar comprendidos entre 0 y 10.
	\item Es importante la distinción entre mayúsculas y minúsculas para los nombres que se elijan puesto que el sistema en algunos puntos hace distinción de caracteres, esto producirá un error en el sistema.
	\item Algunos atributos de las etiquetas XML necesariamente tienen que tomar un valor de entre ciertos propuestos.
	\item Aunque se encuentre en dos ficheros diferentes, un mismo nombre es único para todos, por ejemplo en el caso de las localizaciones.
\end{itemize}

El Sistema de Carga de Datos (SCD de ahora en adelante) que se encarga de cargar la información de cada fichero de configuración en el sistema tiene una serie de restricciones específicas para cada uno de estos que se verán con más detalle en los capítulos correspondientes.
La arquitectura del SCD se puede ver en la Figura \ref{fig:DCLoaders}. 
\begin{figure}[h]
	\centering
	\includegraphics[width=0.9\textwidth]{Imagenes/ModelosGeneradorHistorias_DiagramaDeClaseLoaders}
	\caption{Diagrama de Clase de los SCD}
	\label{fig:DCLoaders}
\end{figure}


%-------------------------------------------------------------------
\newpage
\section{Interfaz Gráfica del Sistema}
\label{cap:Arquitectura:InterfazPersonajes}

La inclusión de un módulo que aporta un componente visual al sistema ayuda a incorporar ciertas funcionalidades de una manera sencilla a éste mucho más allá del factor estético.

La Figura \ref{fig:Gui} muestra la pantalla principal de la interfaz. Los mensajes producidos por los agentes se muestran en esta pantalla para ir creando el hilo de historia.

\begin{figure}[h]
	\centering
	\includegraphics[width=1\textwidth]{Imagenes/gui}
	\caption{Pantalla principal de la interfaz}
	\label{fig:Gui}
\end{figure}
\newpage
La barra de menús contiene tres botones que nos permiten interactuar con el sistema:

\begin{itemize}
	\item Personajes: Ofrece cuadros de herramientas que permiten incorporar nuevos personajes a la historia.
	\item Mapa: Permite seleccionar diferentes imágenes referentes a la escenografía (estas imágenes podemos verlas en el Capítulo \ref{cap:Mapa}).
	\item Iniciar: Botón que empieza la ejecución de los personajes incorporados usando el cuadro de herramientas.
\end{itemize}

La Figura \ref{fig:NuevoPersonaje} es un ejemplo del cuadro de herramientas que permite al usuario agregar nuevos personajes a la historia mientras ésta se está desarrollando.
El usuario puede ir añadiendo personajes continuamente en cualquier momento del transcurso de la historia y todos estos sólo empezarán a ejecutarse cuando se pulse el botón de Iniciar de la pantalla principal. Esto se hace así para dar algo de margen y mantener cierto control a la hora de empezar la ejecución de personajes nuevos.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.3\textwidth]{Imagenes/nuevoPersonaje}
	\caption{Herramienta para incorporar nuevos personajes}
	\label{fig:NuevoPersonaje}
\end{figure}

\newpage
Todo la interfaz mostrada está soportado por un sistema de clases que queda reflejado en la Figura \ref{fig:DCGUI}.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.9\textwidth]{Imagenes/ModelosGeneradorHistorias_DiagramaDeClaseGUI}
	\caption{Diagrama de Clase de la GUI}
	\label{fig:DCGUI}
\end{figure}

\newpage
%-------------------------------------------------------------------
\section{El Logger}
\label{cap:Arquitectura:Logger}

Aunque la interfaz gráfica se encarga de mostrar al usuario en momento de ejecución todas las acciones que han llevado a cabo los agentes y que terminan generando la historia, tener un recopilatorio ó registro de todos eventos y las simulaciones realizadas requiere de una parte del sistema que se encargue de registrar todo lo sucedido en un fichero.

Este componente registra toda la información que generan los agentes, incluyendo el emisor del mensaje, el momento de emisión y el mensaje en sí. No obstante, existen ciertos mensajes que no son registrados en el logger ya que restarían claridad al archivo, estos son los mensajes de control que usan los agentes para comunicarse entre ellos, como los vistos antes en la sección \ref{cap:Arquitectura:SMA:FIPA}.


\section*{}

Son variados y considerablemente complejos cada uno de los componentes que integran toda la arquitectura del sistema que se está desarrollando. Los capítulos siguientes tratan de explicar con mayor nivel de detalle las características que tienen otros elementos internos de la arquitectura y sobre cómo son implementados. Por último se invita al lector, si está interesado en conocer aspectos más específicos sobre el modelo del sistema, a revisar la sección de apéndices al final de este documento donde se incluyen algunos ejemplos de secuencia de los mensajes FIPA transmitidos entre los agentes durante una simulación.