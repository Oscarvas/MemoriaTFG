%---------------------------------------------------------------------
%
%                          Capítulo 5
%
%---------------------------------------------------------------------

\chapter{El Mapa}
\label{cap:Mapa}

\begin{FraseCelebre}
	\begin{Frase}
		Ni el más sabio conoce el fin de todos los caminos.
	\end{Frase}
	\begin{Fuente}
		Gandalf en La Comunidad del anillo por J.R.R.Tolkien
	\end{Fuente}
\end{FraseCelebre}

Las mejores historias siempre se caracterizan por un mapa detrás que les da soporte, que compone los cimientos del mundo que el autor quiere introducir. Este mapa dotará a la historia de individualidad y servirá para orientar al usuario, de manera que este sepa donde se produce la acción.

Tratando de dotar a las historias de un mapa así de consistente, se decidió crear un nuevo mapa que se adecue a un mínimo de necesidades.


%-------------------------------------------------------------------
\section{Diseño del Mapa}
Cuando se planteó el nuevo concepto de mapa lo primero que se tenia claro era enfocarle dentro de un ámbito fantástico y crear un mundo al viejo estilo de las novelas fantásticas, como las de Tolkien, con nombres específicos que representasen reinos y civilizaciones para darle un aire más personal a las historias, pero que a la vez fuese lo suficientemente claro y no estuviese sobrecargado de información nueva para el usuario.


\subsection{Conociendo lo que tenemos}
Cuando se empezó a diseñar el mapa se decidió partir del mapa del proyecto \cite{556}, debido a que este mapa era un plano muy sencillo, con apenas 3 localizaciones conectadas entre sí, y trabajar en un entorno controlado. %Repetido previamente en las que siempre ocurrían las mismas cosas de la misma manera, el dragón iba al castillo, se llevaba a la princesa a la montaña y los caballeros acudían desde el pueblo tratando de derrotar al dragón hasta que finalmente alguno lo lograba y podía llevarla de vuelta al castillo.


Las primeras pruebas fueron trabajar sobre el planificador \ref{cap:Arquitectura:Planificador}, para ver como lidiaba con un problema y trataba de resolverlo con respecto a un mapa y así cuando le se presentasen nuevos mapas seguir teniendo el control sobre el comportamiento de la historia. Con está idea en mente, se desconectó la montaña del pueblo y se interpuso entre el castillo y la montaña dos nuevas localizaciones como se ve el la figura \ref{fig:MapaPrimerasPruebas}, el bosque y el lago. Con esto se logró ver que el planificador devolvía una ruta aleatoria si se quería ir del castillo a la montaña o viceversa, ya que los agentes tenían dos posibles caminos por los que llegar a su destino.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/PreMapaTFG}
	\caption{Mapa de primeras pruebas}
	\label{fig:MapaPrimerasPruebas}
\end{figure}

La siguiente prueba que se realizó al planificador fue para saber como se escogían las localizaciones por las cuales transcurren los agentes para llegar a su destino. Tras diversas pruebas comprobando distintas localizaciones, algunas trampas y unas cuantas horas, descubrimos que el planificador siempre escogía el camino más corto posible para cada agente. Si había dos iguales, elegía indistintamente entre estos e intentaba no repetir con el mismo agente el mismo lugar, es decir, si pasaba con un agente por una localización entre dos posibles a la vuelta elegía la otra. Esto nos permitió conocer en profundidad como actuaba el planificador y así establecer los límites que tendrían que tener cada mapa que se fuese a utilizar.

\subsubsection{Creando el Mapa}
Lo primero que se hizo para empezar a desarrollar el nuevo mapa fue plantearlo geográficamente, de manera que un pequeño mapa empezase a tener forma para dar origen a uno mas grande. Para poder organizarlo bien, utilizamos el concepto de regiones, que actuarían como estados divididos por localizaciones, que serían los lugares de renombre del propio estado, como sus ciudades, bosques, pueblos...


Para ello se creó un archipiélago de islas donde tres islas pequeñas coronaban una isla mayor, que a su vez se dividía en otras tres partes piezas así nuestro mundo en seis regiones, que representan las seis divisiones en las que esta fraccionado el mapa consultable en la figura \ref{fig:MiniMapa},  donde cada cual tenía un numero diferente de localizaciones, que representaban territorios más específicos por los que realmente se moverían los personajes. También se dotó a cada una de estas regiones con un nombre para distinguirlas entre ellas y darle más detalle a la hora de la narrativa.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/MiniMapaTFG}
	\caption{Mini Mapa Final}
	\label{fig:MiniMapa}
\end{figure}


Para seguir aumentando el mapa, el siguiente paso fue profundizar en el contenido de las regiones. Con el objetivo de que cada región fuese única y no se tuviesen sencillamente seis zonas con nombres distintos, decidimos proporcionar a cada una, uno o varios elementos distintivos que la diferencie de las demás a través de un nuevo elemento llamado localizaciones. 
Así por ejemplo, se decidió que sólo en dos regiones hubiese castillo y con estas localizaciones limitar el número de reinos que existen en la historia, pues solo en un castillo podría vivir un único rey.

\label{cap:Mapa:LocalizacionesPNJ}
De igual manera habría localizaciones muy especificas en ciertas regiones. Por ejemplo, en una de ellas estaría la herrería, en otra la taberna, en otra el hospital... Estas localizaciones cumplirían las veces de sitios sencillos que albergan personajes secundarios que pueden cambiar el curso de la historia o sencillamente hacer acto de presencia en él. Así, en estos sitios, aguardarían estos nuevos personajes esperando el momento de su intervención, estando estos personajes ligados a una localización particular en específico, como en este caso serian el herrero, el tabernero o la amable enfermera.


Con el fin de dotar al resto de personajes de lugares en los que entrar en la historia, decidimos añadir una nueva característica al mapa, concretamente la de tipos de localizaciones.
A través de esta nueva característica, buscamos clasificar nuestras localizaciones según un elemento común. Así, de todas aquellas localizaciones en el mapa que fuesen bosques sabríamos que lo eran y podríamos interpretarlas correctamente para trabajar con ellas en conjunto. 
De esta manera clasificamos las localizaciones en los siguientes tipos: castillo, pueblo, urbano (que se referían a las localizaciones específicas previamente comentadas como la herrería), bosque, lago, guarida y camino.

\label{cap:Mapa:LocalizacionesAleatoriasSegunClase}
Esta clasificación en tipos nos ayudaría a la hora de crear personajes, asignándole a cada clase o monstruo un tipo de localización en concreto, de forma que al crearse dicho personaje fuese situado aleatoriamente en una de las localizaciones que tuviesen el tipo al que dicha clase o monstruo pertenecían. De esta manera, si a la clase o monstruo X le asignabas el tipo de localización Y, a ese personaje se le cedería una localización específica Z que perteneciese al conjunto de localizaciones del tipo Y.
El orden final se puede consultar en la tabla \ref{fig:TablaRelacionLozalizaciones}:


\begin{table}[h!]
	\centering
	\begin{tabular}{c|c}
		Clase o Monstruo		& Tipo de Localización \\ \hline
		Allegado a la Víctima	& Castillo \\
		Víctima 				& Castillo (el del padre) \\
		Aspirante a Héroe		& Pueblo \\
		Ayudante del Héroe		& Urbano \\
		PNJ's 					& Urbano(elección específica) \\
		Monstruo Secuestrador	& Guarida \\
		Monstruo Emboscador 	& Bosque \\
		Monstruo Guardian 		& Lago \\
		Monstruo Maligno		& Cualquiera \\ \hline
	\end{tabular}
	\caption{Tabla de Relación Clase-Localización}
	\label{fig:TablaRelacionLozalizaciones}
\end{table}

Finalmente, se decidió que todas estas características pudiesen ser configuradas por el usuario, a través de un archivo XML, donde pudiese diseñar siempre dentro de unos ciertos parámetros su propio mapa.

Una vez ya decidida la funcionalidad que tendría nuestro mapa, era el momento de plasmarlo en un mapa virtual, una imagen intuitiva que ayudase al usuario a situarse en la historia. Para ello, dibujamos un primer boceto en papel y procedimos a digitalizarlo, para lo cual usamos la herramienta GIMP.

Una vez correctamente digitalizado se introduce en la GUI, aportando un gran impacto visual y estando listo para consultar (ver figura \ref{fig:MapaCompleto}).

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/MapaTFGMem}
	\caption{Mapa Final}
	\label{fig:MapaCompleto}
\end{figure}


%-------------------------------------------------------------------
\section{Implementación del Mapa}
Para que el mapa fuese configurable y pudiese cargar sus datos a través de un archivo XML fue necesaria una remodelación profunda del mismo, produciendo las modificaciones que se explicaran a continuación.

De igual manera, para poder usar de forma correcta el mapa, este debía estar en el Agente \texttt{Mundo}, tal y como se explica en el apartado \ref{cap:Arquitectura:AgenteMundo}, creando las clases necesarias para ello.


\subsection{Mapas configurables por el usuario}
El mapa original era un archivo XML lleno de \textit{Strings}, que representaban los nombres de las distintas localizaciones, volcados en un XML, y se cargaba directamente en la aplicación.

Para poder usarse de la manera correcta, primero se debía contar con un SCD capaz de interpretar los datos del mapa. Sin embargo, los datos del mapa debían ser conocidos por el Agente \texttt{Mundo} y por tanto se integra este SCD dentro del propio agente dándole la funcionalidad de \texttt{CargarMapa()}.

La función que actuaba como el SCD del archivo del mapa funcionaba básicamente como el resto de SCD's, ver apartado \ref{cap:Arquitectura:Loaders}, con la particularidad de que este iniciaba un objeto de la clase \texttt{Mapa}, que venía a ser un \textit{ArrayList} de localizaciones, y recorría los nodos del archivo XML buscando la etiqueta \texttt{<localización>} a partir de la cual cargaba nuevas localizaciones. 
Sin embargo, al cargar el mapa no solo se cargaban las localizaciones, sino que también se debía cargar la matriz de adyacencia de estas para que el agente Mundo fuese capaz de interpretar correctamente el mapa. Para ello, dentro de cada localización, en la carga se buscaba la etiqueta \texttt{<conectadoCon>} donde estaban aquellas localizaciones conectadas con la que se estaba cargando.

Para que estas cargas se pudiesen realizar correctamente fue necesaria la inclusión de dos nuevas clases, la clase \texttt{Mapa} y la clase \texttt{Localización}, que se explican en detalle en el apartado \ref{cap:Mapa:ClaseMapaLocalizacion}. %aunque no se si es mejor poner que explicaremos al final del capitulo en vez de la ref

Para introducir también la relación entre clases y localizaciones, al archivo XML se le introdujo la relación de tipos, como ya se comento en el capítulo de diseño. Estas localizaciones se guardaban en un \textit{ArrayList} auxiliar, donde estaban ordenadas según su tipo, permitiendo así a los personajes acceder al tipo que buscaban y decidir de manera aleatoria su localización de origen entre las localizaciones de ese tipo.

El problema que representaba esta implementación es que al necesitar el mapa de una configuración tan específica, el archivo XML debía crearse de una manera determinada, pues si no la aplicación no funcionaría de una manera correcta.
Para que esto no ocurra, en el archivo XML del mapa se incluye una pequeña guía de cómo construirlo, aparte de proponer por defecto el mapa final cuya figura aparece en el diseño, que también hace las veces de ejemplo. Quedaría algo así:

\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML del Mapa},label=escenografiaXML]

<?xml version="1.0" encoding="UTF-8"?>
<Mapa>
	<region nombre="[nombreRegión]">
		<localizacion id="[nombreLocalización]" 
			tipo="[Pueblo|Bosque|Guarida|Urbano|Castillo|Lago]" >
			
			<conectadoCon>[nombreLocalización [nombreLocalización ...]]
				</conectadoCon>
		</localizacion>    
	</region>
</Mapa>

\end{lstlisting}
%\label{ejemploXML:mapa}
%\begin{lstlisting}[basicstyle=\tiny]
%<region nombre="[NombreRegion]">
%<localizacion id="[NombreLocalizacion]" tipo="[TipoLocalizacion]" > 
%<conectadoCon>[NombreRegiones con las que conecta]</conectadoCon>
%</localizacion>
%</region>
%\end{lstlisting}

\subsection{Las Clases Mapa y Localización y cómo localizar personajes}
\label{cap:Mapa:ClaseMapaLocalizacion}
La Clase \texttt{Localización} permite trabajar con las localizaciones de una manera más funcional, ligando al \textit{String} identificativo de la localización con su tipo (bosque, lago, etc.)

De igual manera, la Clase \texttt{Localización} permite al Agente \texttt{Mundo} conocer que personajes y objetos interactuan con ella así como con que localizaciones está conectada.

La Clase \texttt{Mapa} posibilita tener un conjunto de localizaciones fácilmente accesible por el Agente \texttt{Mundo} y acceder a localizaciones específicas de este.

De forma similar, para localizar a los personajes se crea la Interfaz \texttt{Vocabulario} junto al Enumerado \texttt{Mitología}, que permite ligar clases a tipos de localizaciones específicas para posteriormente elegir mediante una selección aleatoria dentro de la lista de localizaciones específicas de cada clase cual sería su localización inicial.

%-------------------------------------------------------------------