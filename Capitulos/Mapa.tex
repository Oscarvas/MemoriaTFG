%---------------------------------------------------------------------
%
%                          Capítulo 5
%
%---------------------------------------------------------------------

\chapter{El Mapa}

\begin{FraseCelebre}
\begin{Frase}
	Ni el más sabio conoce el fin de todos los caminos.
\end{Frase}
\begin{Fuente}
	Gandalf en La Comunidad del anillo por J.R.R.Tolkien
\end{Fuente}
\end{FraseCelebre}

Las mejores historias siempre se caracterizan por un mapa detrás que las da soporte, que compone los cimientos del mundo que el autor quiere introducir. Este mapa dotará a la historia de individualidad y servira para orientar al usuario, de manera que este sepa donde se produce la acción.

Tratando de dotar a nuestras historias de un mapa así de consistente, decidimos cambiar el antiguo mapa y crear uno nuevo que se adecuase a nuestras necesidades:


%-------------------------------------------------------------------
\section{Diseño del Mapa}
Cuando nos planteamos el nuevo concepto de mapa lo primero que teníamos claro era que queríamos darle un aire fantástico a nuestra historia, así que nos propusimos crear un mundo al viejo estilo de las novelas fantásticas, como las de Tolkien, con nombres específicos que representasen reinos y civilizaciones, para darle un aire mas personal a nuestras posibles historias, buscando un sentido de pertenencia, nuestro y del usuario, que tratase de emular, salvando las distancias, al que debió tener el propio Tolkien al crear su mundo.

\subsection{Conociendo lo que tenemos}
El anterior mapa del TFG era un plano muy sencillo, con apenas 3 localizaciones conectadas entre sí en las que siempre ocurrían las mismas cosas de la misma manera, el dragón iba al castillo, se llevaba a la princesa a la montaña y los caballeros acudían desde el pueblo tratando de derrotar al dragón hasta que finalmente alguno lo lograba y podía llevarla de vuelta al castillo. 


Para nuestras primeras pruebas lo primero que hicimos fue hacer dudar al planificador, para ver como lidiaba con un problema y trataba de resolverlo, así cuando le presentásemos nuestro mapa sabríamos como se comportaría, de manera que desconectamos la montaña del pueblo e interpusimos entre el castillo y la montaña dos nuevas localizaciones, el bosque y el lago. Así, si se quería ir del castillo a la montaña, o viceversa, los agentes tenían dos posibles caminos e, incapaces de decidir por ellos mismos, nuestro planificador se encargaría de elegir entre el bosque y el lago de manera aleatoria.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/PreMapaTFG}
	\caption{Mapa de primeras pruebas}
	\label{fig:MapaPrimerasPruebas}
\end{figure}

La siguiente prueba que le hicimos a nuestro planificador fue saber como escogía las localizaciones por las cuales se moverían nuestros agentes. Tras diversas pruebas probando localizaciones, algunas trampas y unas cuantas horas, descubrimos que el planificador siempre escogía el camino mas corto posible para cada agente, si había dos iguales, elegía indistintamente entre estos e intentaba no repetir con el mismo agente el mismo lugar, es decir, si pasaba con un agente por una localización entre dos posibles a la vuelta elegía la otra. Esto nos permitió conocer en profundidad como actuaba nuestro planificador, y nos daba paso a poder hacer el mapa que realmente queríamos tener.

\subsubsection{Creando el Mapa}
Lo primero que debíamos hacer para empezar a desarrollar nuestro mapa era plantearlo geográficamente, de manera que un pequeño mapa empezase a tener forma para dar origen a uno mas grande.


Para ello, creamos un archipiélago de islas donde tres islas pequeñas coronaban una isla mayor,  que a su vez se dividía en otras tres partes, dividiendo así nuestro mundo en seis regiones, donde cada cual tenía un numero diferente de localizaciones. También, dotamos a cada una de estas regiones de un nombre para distinguirlas entre ellas.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/MiniMapaTFG}
	\caption{Mini Mapa Final}
	\label{fig:MiniMapa}
\end{figure}


Para seguir aumentando el mapa, nuestro siguiente paso fue profundizar en el contenido de las regiones. Con el objetivo de que cada región fuese única y no tuviésemos sencillamente seis zonas con nombres distintos, decidimos proporcionar a cada una uno o varios elementos distintivos, que la diferenciase de las demás. 
Así, por ejemplo, decidimos que solo en dos regiones habría castillos, lo cual a su vez limitaba a que solo hubiese dos reinos en nuestro mapa, pues solo en un castillo podría vivir un rey.


De igual manera, habría localizaciones muy especificas en ciertas regiones, por ejemplo en una de ellas estaría la herrería, en otra la taberna, en otra el hospital... Estas localizaciones cumplirían las veces de sitios sencillos que albergan personajes secundarios que pueden cambiar el curso de la historia o sencillamente hacer acto de presencia en el. Así, en estos sitios, aguardarían estos nuevos personajes esperando el momento de su intervención, siendo estos personajes específicos ligados a cada localización, como en este caso serian el herrero, el tabernero o la amable enfermera.


Para suplirla, decidimos añadir una nueva característica al mapa, concretamente la de tipos de localizaciones.
A través de esta nueva característica, buscamos clasificar nuestras localizaciones según un elemento común, así de todas aquellas localizaciones en el mapa que fuesen bosques sabríamos que lo eran y podríamos interpretarlas correctamente para trabajar con ellas en conjunto. 
De esta manera clasificamos las localizaciones en los siguientes tipos: castillo, pueblo, urbano (que se referían a las localizaciones específicas previamente comentadas como la herrería), bosque, lago, guarida y camino.

Esta clasificación en tipos nos ayudaría a la hora de crear personajes, asignándole a cada clase o monstruo un tipo de localización en concreto, de forma que al crearse dicho personaje fuese situado aleatoriamente en una de las localizaciones que tuviesen el tipo al que dicha clase o monstruo pertenecían. De manera que si a la clase o monstruo X le asignabas el tipo de localización Y, a ese personaje se le cedería una localización específica Z que perteneciese al conjunto de localizaciones del tipo Y.

El orden final nos quedaría así:


\begin{table}[h!]
	\centering
	\begin{tabular}{c|c}
		$Clase / Monstruo$			& $Tipo Localización$ \\ \hline
		Rey 					& Castillo \\
		Princesa 				& Castillo (el del padre) \\
		Caballero 				& Pueblo \\
		Druida 					& Bosque \\
		Mago 					& Urbano \\
		PNJ's 					& Urbano(elección específica) \\
		Monstruo Secuestrador	& Guarida \\
		Monstruo Emboscador 	& Bosque \\
		Monstruo Guardian 		& Lago \\
		Monstruo Maligno		& Cualquiera \\ \hline
	\end{tabular}
	\caption{Tabla de Relacion Clase-Localización}
	\label{fig:TablaRelacionLozalizaciones}
\end{table}


Una vez ya habíamos decidido la funcionalidad que tendría nuestro mapa, era el momento de plasmarlo en un mapa virtual, una imagen intuitiva que ayudase al usuario a situarse en la historia. Para ello, dibujamos un primer boceto en papel y procedimos a digitalizarlo, para lo cual usamos la herramienta GIMP.

Una vez correctamente digitalizado, lo introdujimos en la GUI, aportándonos un gran impacto visual y dejándolo listo para usarse.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/MapaTFGMem}
	\caption{Mapa Final}
	\label{fig:MapaCompleto}
\end{figure}


%-------------------------------------------------------------------
\section{Implementación del Mapa}
Con el Mapa ya diseñado y teniendo en cuenta las ganas que teníamos de que toda la aplicación fuese configurable, decidimos que el Mapa también cargase sus datos de un archivo XML, y por tanto debimos realizar los cambios que esta modificación necesitaba.

De igual manera, para poder usar de manera correcta nuestro mapa, sabíamos que debía estar en el agente mundo, tal y como se explico en su capítulo (poner referencia aquí), creando las clases necesarias para ello.


\subsection{Mapas configurables por el usuario}
El mapa original era un archivo XML lleno de Strings, que representaban los nombres de las distintas localizaciones, volcados en un XML, que se cargaba directamente en la aplicación.

Para poder usarlo de la manera correcta primero debía contar con un loader capaz de interpretar los datos del mapa. Sin embargo, los datos del mapa debían ser conocidos por el agente Mundo y por tanto integramos este loader dentro del propio agente, dándole a este la funcionalidad de CargarMapa().

La función que actuaba como el loader del archivo del mapa funcionaba básicamente como el resto de loaders(referencia a la arquitectura, donde se expliquen los loaders), con la particularidad de que este iniciaba un objeto de la clase Mapa, que venía a ser un ArrayList de localizaciones, y recorría los nodos del archivo XML buscando la etiqueta <localizacion> a partir de la cual cargaba nuevas localizaciones. 
Sin embargo, al cargar el mapa no solo se cargaban las localizaciones, sino también se debía cargar la matriz de adyacencia de estas, de manera que el agente Mundo fuese capaz de interpretar correctamente el mapa. Para ello, dentro de cada localizacion en la carga se buscaba la etiqueta <conectadoCon> donde estaban aquellas localizaciones conectadas con la que se estaba cargando.

Para que estas cargas se pudiesen realizar correctamente fueron necesarias la inclusión de dos nuevas clases, la clase Mapa y la clase Localización, que explicaremos en detalle mas adelante (incluir referencia).

Para introducir también la relación entre clases y localizaciones, al archivo XML se le introdujo la relación de tipos, como ya se comento en el capítulo de diseño. Aparte estas localizaciones se guardaban en un ArrayList auxiliar, donde estaban ordenadas según su tipo, permitiendo así a los personajes acceder al tipo que buscaban y tras realizar un random entre las localizaciones de ese tipo elegir finalmente en cual iban a empezar.

El problema que representaba esta implementación es que necesitar el mapa de una configuración tan específica, el archivo XML debía crearse de una manera determinada, pues sino la aplicación no funcionaría de una manera correcta.
Para que esto no ocurra, en el archivo XML del mapa se incluye una pequeña guía de como construirlo, aparte de proponer por defecto el mapa final cuya figura aparece en el diseño, que también hace las veces de ejemplo.

\begin{verbatim}
	<region nombre="[NombreRegion]">
		<localizacion id="[NombreLocalizacion]" tipo="[TipoLocalizacion]" > 
			<conectadoCon>[NombreRegiones con las que conecta]</conectadoCon>
		</localizacion>
	</region>
\end{verbatim}

\subsection{Las Clases Mapa y Localización}
La clase Localización nos permitía trabajar con las localizaciones de una manera mas funcional, pudiendo ligar al String, que era realmente el elemento identificativo de la localización, a su tipo, de manera que supiésemos de cada localización si eran un bosque, un lago,...

De igual manera, la Clase Localización permitía al agente mundo conocer que personajes y objetos interactuaban con ella así como con que localizaciones estaba conectada.

La Clase Mapa nos permitía tener un conjunto de localizaciones fácilmente accesible por el agente Mundo y acceder a localizaciones específicas de este.

%-------------------------------------------------------------------