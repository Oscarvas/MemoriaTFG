%---------------------------------------------------------------------
%
%                          Capítulo 5
%
%---------------------------------------------------------------------

\chapter{El Mapa}
\label{cap:Mapa}

\begin{FraseCelebre}
	\begin{Frase}
		Ni el más sabio conoce el fin de todos los caminos.
	\end{Frase}
	\begin{Fuente}
		Gandalf en La Comunidad del anillo por J.R.R.Tolkien
	\end{Fuente}
\end{FraseCelebre}

Las mejores historias siempre se caracterizan por un mapa detrás que les da soporte, que compone los cimientos del mundo que el autor quiere introducir. Este mapa dotará a la historia de individualidad y servirá para orientar al usuario, de manera que este sepa donde se produce la acción.

Tratando de dotar a las historias de un mapa así de consistente, se decide crear un mapa que se adecue a un mínimo de necesidades.


%-------------------------------------------------------------------
\section{Diseño del Mapa}
Cuando se plantea el nuevo concepto de mapa lo primero que se decide es enfocarle dentro de un ámbito fantástico y crear un mundo al viejo estilo de las novelas fantásticas, como las de Tolkien, con nombres específicos que representen reinos y civilizaciones para darle un aire más personal a las historias, pero que a la vez sea lo suficientemente claro y no este sobrecargado de información nueva para el usuario.


\subsection{Conociendo lo que tenemos}
Cuando se empieza a diseñar el mapa se decide partir del mapa del proyecto \cite{556}, debido a que este mapa es un plano muy sencillo, consultable en la figura \ref{fig:MapaBase}, y permite trabajar en un entorno controlado.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/PrimerMapaBasico}
	\caption{Mapa Base}
	\label{fig:MapaBase}
\end{figure}
 %Repetido previamente en las que siempre ocurrían las mismas cosas de la misma manera, el dragón iba al castillo, se llevaba a la princesa a la montaña y los caballeros acudían desde el pueblo tratando de derrotar al dragón hasta que finalmente alguno lo lograba y podía llevarla de vuelta al castillo.


Las primeras pruebas consisten en trabajar sobre el planificador, consultable en el capítulo \ref{cap:Arquitectura:Planificador}, para ver como éste lidia con un problema y trata de resolverlo con respecto a un mapa, de manera que cuando le se presenten nuevos mapas se pueda mantener el control sobre el comportamiento de la historia. Con está idea en mente, se desconecta la montaña del pueblo y se interpone entre el castillo y la montaña dos nuevas localizaciones, como se ve en la figura \ref{fig:MapaPrimerasPruebas}, el bosque y el lago. Con esto se logra ver que el planificador devuelve una ruta aleatoria si se quiere ir del castillo a la montaña o viceversa, ya que los agentes tienen dos posibles caminos por los que llegar a su destino.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/PreMapaTFG}
	\caption{Mapa de primeras pruebas}
	\label{fig:MapaPrimerasPruebas}
\end{figure}

La siguiente prueba que se realiza al planificador es para saber como se escogen las localizaciones por las cuales transcurren los agentes para llegar a su destino. Tras diversas pruebas con distintas localizaciones y algunas trampas, se descubre que el planificador siempre trata de escoger el camino más corto posible para cada agente. Si hay dos iguales, elige indistintamente entre estos e intenta no repetir con el mismo agente el mismo lugar, es decir, si pasa con un agente por una localización entre dos posibles a la vuelta elige la otra. Esto permite conocer en profundidad la manera de actuar del planificador y así se pueden establecer los límites que ha de tener cada mapa que se vaya a utilizar. Una vez conocidos estos límites y como los trata el planificador, se empieza a desarrollar el nuevo mapa.

\subsubsection{Creando el Mapa}
Al empezar a desarrollar el nuevo mapa, primero se plantea el mismo geográficamente, de manera que un pequeño mapa vaya tomando forma para dar origen a uno más grande. Para poder organizarlo bien, se utilizan varios conceptos para dividirlo. Así, se crean las regiones, que representan estados subdivididos a su vez en localizaciones, que conforman los lugares de renombre del propio estado, como sus ciudades, bosques, o pueblos.

Para desarrollar el mapa, se crea un archipiélago de islas donde tres islas pequeñas coronan a una isla mayor que a su vez se divide en otras tres partes, dividiendo así el mundo en seis regiones, que representan las seis divisiones en las que esta fraccionado el mapa consultable en la figura \ref{fig:MiniMapa}, donde cada región tiene un número diferente de localizaciones, que representan territorios más específicos por los que realmente se moverán los personajes. También se dota a cada una de estas regiones de un nombre en específico para distinguirlas entre ellas y entender mejor el mapa.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/MiniMapaTFG}
	\caption{Mini Mapa Final}
	\label{fig:MiniMapa}
\end{figure}

Con ánimo de seguir aumentando el mapa, se procede a profundizar en el contenido de las regiones. Con el objetivo de que cada región sea única y no se tengan sencillamente seis zonas con seis nombres distintos, se decide proporcionar a cada una, uno o varios elementos distintivos que la diferencien del resto de regiones a través de localizaciones, siendo algunas de estas exclusivas de cada región.
Así, por ejemplo, se decide que solo en dos regiones habrá un castillo, limitando así el número de reinos existentes en la historia a dos.

\label{cap:Mapa:LocalizacionesPNJ}
De la misma manera, se forman localizaciones particulares en ciertas regiones.  Por ejemplo, en una de ellas estará la herrería, en otra la taberna, en otra el hospital... Estas localizaciones cumplirán las veces de sitios sencillos que albergan personajes secundarios que pueden cambiar el curso de la historia o sencillamente hacer acto de presencia en él. Así, en estos sitios, aguardan estos nuevos personajes esperando el momento de su intervención, estando estos personajes ligados a una localización particular en específico, como en este caso serán el herrero, el tabernero o la amable enfermera.

Con el fin de dotar al resto de personajes de lugares en los que entrar en la historia, se decide añadir una nueva característica al mapa, concretamente la de tipos de localizaciones.
A través de esta nueva característica, se busca clasificar las localizaciones según un elemento común. Así, todas aquellas localizaciones en el mapa que sean bosques podrán ser tratados como tal para poder trabajar correctamente con ellos en conjunto.
De esta manera se clasifica a las localizaciones en los siguientes tipos: castillo, pueblo, urbano (que se refiere a las localizaciones específicas previamente comentadas como la herrería), bosque, lago, guarida y camino.

\label{cap:Mapa:LocalizacionesAleatoriasSegunClase}
Esta clasificación en tipos ayudará a la hora de crear personajes, asignándole a cada protagonista o antagonista un tipo de localización en concreto, de forma que al crearse dicho personaje sea situado aleatoriamente en una de las localizaciones que tengan el tipo al que dicho personaje pertenece. De esta manera, si al protagonista o antagonista X le asignas el tipo de localización Y, a ese personaje se le cede una localización específica Z que pertenece al conjunto de localizaciones del tipo Y.
El orden final se puede consultar en la tabla \ref{fig:TablaRelacionLozalizaciones}:


\begin{table}[h!]
	\centering
	\begin{tabular}{c|c}
		Protagonista o Antagonista 	& Tipo de Localización \\ \hline
		Allegado a la Víctima		& Castillo \\
		Víctima 					& Castillo (el del padre) \\
		Aspirante a Héroe			& Pueblo \\
		Ayudante del Héroe			& Urbano \\
		PNJ's 						& Urbano(elección específica) \\
		Monstruo Secuestrador		& Guarida \\
		Monstruo Emboscador 		& Bosque \\
		Monstruo Guardian 			& Lago \\
		Monstruo Maligno			& Cualquiera \\ \hline
	\end{tabular}
	\caption{Tabla de Relación Clase-Localización}
	\label{fig:TablaRelacionLozalizaciones}
\end{table}

Finalmente, se decide que todas estas características puedan ser configuradas por el usuario, a través de un archivo XML, donde el usuario pueda diseñar, siempre dentro de unos ciertos parámetros, su propio mapa.

Una vez ya decidida la funcionalidad que tendrá el mapa, es el momento de plasmarlo en un mapa virtual, una imagen intuitiva que ayude al usuario a situarse en la historia. Para ello, se dibuja un primer boceto en papel y se digitaliza, a través de la herramienta GIMP.
Una vez correctamente digitalizado se introduce en la interfaz gráfica, aportando un gran impacto visual y quedando listo para ser consultado (ver figura \ref{fig:MapaCompleto}).

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/MapaTFGMem}
	\caption{Mapa Final}
	\label{fig:MapaCompleto}
\end{figure}


%-------------------------------------------------------------------
\section{Implementación del Mapa}
Para que el mapa sea configurable y pueda cargar sus datos a través de un archivo XML es necesario un sistema de carga e interpretación que conlleva consigo distintas aportaciones al código, que a continuación se ven en profundidad.

De igual manera, para poder usar de forma correcta el mapa, es importante destacar la necesidad de el \texttt{Agente Mundo}, que puede cargar e interpretar en toda su magnitud el mapa, tal y como se explica en el apartado \ref{cap:Arquitectura:AgenteMundo}, lo que precisa de la adición de las clases que permiten que esto ocurra.


\subsection{Mapas configurables por el usuario}
El mapa es un archivo XML donde la información llega en forma de \textit{Strings}, que representan los nombres de las distintas localizaciones, y se carga directamente en la aplicación.

Para poder usarse de la manera correcta, primero se debe contar con un SCD capaz de interpretar los datos del mapa. Sin embargo, los datos del mapa deben ser conocidos por el \texttt{Agente Mundo} y por tanto se integra este SCD dentro del propio agente dándole la funcionalidad de \texttt{CargarMapa()}.

La función que actúa como el SCD del archivo del mapa funciona básicamente como el resto de SCD's, ver capítulo \ref{cap:Arquitectura:Loaders}, con la particularidad de que este inicia un objeto de la clase \texttt{Mapa}, que viene a ser un \textit{ArrayList} de localizaciones, y recorre los nodos del archivo XML buscando la etiqueta \texttt{<localización>} a partir de la cual carga nuevas localizaciones. 
Sin embargo, al cargar el mapa no solo se cargan las localizaciones, sino que también se debe cargar la matriz de adyacencia de estas para que el \texttt{Agente Mundo} sea capaz de interpretar correctamente el mapa. Para ello, dentro de cada localización, en la carga se busca la etiqueta \texttt{<conectadoCon>} donde se reflejan aquellas localizaciones adyacentes a la localización que esta siendo cargada.

Para que estas cargas se puedan realizar correctamente es necesaria la inclusión de dos nuevas clases, la clase \texttt{Mapa} y la clase \texttt{Localización}, que se explican en detalle en el apartado \ref{cap:Mapa:ClaseMapaLocalizacion}.

Para introducir la relación entre clases y localizaciones, al archivo XML se le introduce la relación de tipos, como ya se comentó en el capítulo de diseño. Estas localizaciones se guardan en un \textit{ArrayList} auxiliar, donde están ordenadas según su tipo, permitiendo así a los personajes acceder al tipo que buscan y decidir de manera aleatoria su localización de origen entre las localizaciones de dicho tipo.

El problema que representa esta implementación es que al necesitar el mapa de una configuración tan específica, el archivo XML debe crearse bajo unos parámetros determinados, pues si no, la aplicación no funcionará de una manera correcta.
Para que esto no ocurra, en el archivo XML del mapa se incluye una pequeña guía de cómo construirlo, aparte de proponer por defecto el mapa final cuya figura aparece en el diseño, que también hace las veces de ejemplo. El formato de construcción se puede consultar en el cuadro \ref{escenografiaXML}.

\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML del Mapa},label=escenografiaXML]

<?xml version="1.0" encoding="UTF-8"?>
<Mapa>
	<region nombre="[nombreRegión]">
		<localizacion id="[nombreLocalización]" 
			tipo="[Pueblo|Bosque|Guarida|Urbano|Castillo|Lago]" >
			
			<conectadoCon>[nombreLocalización [nombreLocalización ...]]
				</conectadoCon>
		</localizacion>    
	</region>
</Mapa>

\end{lstlisting}
%\label{ejemploXML:mapa}
%\begin{lstlisting}[basicstyle=\tiny]
%<region nombre="[NombreRegion]">
%<localizacion id="[NombreLocalizacion]" tipo="[TipoLocalizacion]" > 
%<conectadoCon>[NombreRegiones con las que conecta]</conectadoCon>
%</localizacion>
%</region>
%\end{lstlisting}

\subsection{Las Clases Mapa y Localización y cómo localizar personajes}
\label{cap:Mapa:ClaseMapaLocalizacion}
La Clase \texttt{Localización} permite trabajar con las localizaciones de una manera más funcional, ligando al \textit{String} identificativo de la localización con su tipo (bosque, lago, etc.)

De igual manera, la Clase \texttt{Localización} permite al \texttt{Agente Mundo} conocer que personajes y objetos interactúan con ella, así como con que localizaciones está conectada.

La Clase \texttt{Mapa} posibilita tener un conjunto de localizaciones fácilmente accesible por el \texttt{Agente Mundo} y acceder a localizaciones específicas de este.

De forma similar, para localizar a los personajes se crea la Interfaz \texttt{Vocabulario} junto al Enumerado \texttt{Mitología}, que permite ligar tipos de personajes a tipos de localizaciones específicas para posteriormente elegir, mediante una selección aleatoria dentro de la lista de localizaciones específicas de cada tipo de personaje, cual será la localización inicial del personaje.

%-------------------------------------------------------------------