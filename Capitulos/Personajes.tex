%---------------------------------------------------------------------
%
%                          Capítulo 6
%
%---------------------------------------------------------------------

\chapter{Los Personajes}
\label{cap:Personajes}

\begin{FraseCelebre}
\begin{Frase}
\end{Frase}
\begin{Fuente}
\end{Fuente}
\end{FraseCelebre}

Si quieres dar variedad a tu historia esta debe contar con una gran diversidad de personajes, cada uno con sus virtudes y limitaciones, y a cuantos mas personajes haya más posibilidades tendrás de crear diferentes historias, ya que cada uno podría actuar de manera distinta en cada ejecución. 

Con este objetivo en mente propusimos un nuevo diseño para nuestros personajes.
Sin embargo las posibles historias que podamos generar comparten siempre una misma estructura, ya que no puede ser de otra manera. 
Siempre aparecerá un antagonista que logrará secuestrar a la princesa, el rey pedirá ayuda a los distintos aspirantes a héroes y estos acudirán a su llamada intentando salvarla, a partir de lo cuál aparecerán distintos personajes.
Para poder diseñar correctamente estos diversos personajes lo primero que debíamos hacer era concretar unos tipos que definiesen en cierta medida cual sería su manera de participar en la historia. De esta manera decidimos dividir a nuestros posibles personajes en tres tipos concretos, que serían: \texttt{Protagonistas}, \texttt{Antagonistas} y \texttt{Personajes no Jugadores} o \texttt{PNJs}.

De esta manera los \texttt{Protagonistas} llevarían el peso de la historia, representando aquellos personajes con los que el usuario se puede identificar y asumirían el rol de los ``buenos'' dentro de la narración. Los \texttt{Antagonistas}, por su parte, actuarían en contra de los intereses de los protagonistas, proponiendo problemas que estos deben resolver para el transcurso de la historia y asumiendo el papel de ``malos'' en la misma. Por último, los \texttt{PNJs} representarán los personajes secundarios que intervendrían en una narración, modificando la manera en la que esta discurre pero sin llegar a tener un papel clave en la historia, sino mas bien un papel de apoyo u oposición con respecto a los protagonistas.

También es importante indicar que todos los personajes se planificarán en algún momento de su ejecución. Para entender realmente como se planifican y el papel que juega el planificador en su manera de ejecutarse, es recomendable comprender bien el capitulo \ref{cap:Arquitectura:Planificador}.

%aqui yo introduciria el diagrama del que de los personajes salen las 3 clases.

%para las comillas ``inteligencia''



\section{Protagonistas}
Para que la historia fuese rica necesitábamos de no solo uno sino varios personajes principales con los que disponer en el transcurso natural de la historia, pues cuantos mas personajes hubiera, mejores historias podríamos crear. Lo natural en estos casos es que los protagonistas no sean meras copias unos de otros, así que decidimos que dentro de los propios protagonistas debía haber una nueva división de tipos.

\subsection{Diseño de los Protagonistas}
En la búsqueda de unos protagonistas para nuestras historias decidimos partir de aquellos ya planteados, como se ve en el capítulo \ref{cap:PrimerosPasos}, pero para que estos personajes fuesen originales y pudiesen cumplir papeles diversos en la historia fue necesaria la inclusión del concepto de clase dentro de los protagonistas. Estas clases nos ayudarían a parametrizar los pasos que seguiría cada clase de personajes dentro de la historia y así darles a cada clase ciertas funcionalidades específicas. 
De igual manera, también es importante remarcar que los protagonistas serán los únicos que podrán obtener y consumir recursos, tal y como se explica en el capítulo \ref{cap:Objetos} referente a los objetos.
A continuación veremos los diferentes tipos de protagonistas.

\subsubsection{La Princesa}
La Princesa cumplía un rol muy importante dentro de nuestras historias. Ella siempre era raptada por un antagonista y a partir de ese momento desencadenaba la acción de los distintos protagonistas repartidos por el mundo, y las diversas pruebas por las que debían pasar hasta que por fin fuese salvada.
Sin embargo, nuestra idea del personaje ``Princesa'' no acababa ahí, sino que también queríamos que fuese un personaje capaz de actuar por iniciativa propia. Por tanto, en nuestra búsqueda de la princesa fuerte e independiente, decidimos que ésta también fuese capaz de escapar por su propio pie. Así, cuando los caballeros se demoraban demasiado, la princesa se iba impacientando mientras evaluaba sus posibilidades de éxito, hasta que finalmente decidía emprender la huida por su cuenta. Esto no quiere decir que la princesa se escapase siempre, simplemente a veces lo conseguía y a veces no.

\subsubsection{El Rey}
El Rey cumplía un papel mas formal dentro de la historia. Su principal uso era el de tener un personaje intermedio para que los distintos personajes se pudiesen comunicarse entre sí, pero no por ello era menos importante, ya que sin su ayuda la historia no podría transcurrir de manera fluida.
La empresa del rey era la de contratar a los distintos caballeros del reino cuando alguna de sus hijas era secuestrada. Así, el Rey les pedía ayuda a estos aspirantes a héroes con la esperanza de que alguno pudiese rescatar a su preciada hija.

\subsubsection{Los Caballeros}
El propósito de los Caballeros en la historia era cumplir el papel de héroes. Para ello debían emprender su camino con el objetivo de rescatar a la princesa de su malvado secuestrador, enfrentándose por el camino a las distintas pruebas propuestas por el resto de los antagonistas.
En estas pruebas el caballero deberá hacer uso de los diversos recursos que tenga a su alcance, que representaremos mediante los objetos, o incluso necesitará ayuda de otros personajes para poder superarlas, que forman parte de la historia como otros protagonistas.

\subsubsection{El Mago}
El Mago cumplirá el papel del personaje que ayuda en un momento crucial de la historia al héroe de la misma. La forma de funcionar de este personaje se entiende cuando el caballero tiene un encuentro con un antagonista en específico, en este caso el guardián.
El caballero, que por si solo no es capaz de enfrentarse al guardián, pedirá apoyo a un mago, el cual acudirá en su ayuda bajo el precio de poder quedarse con el objeto que este antagonista guardián mantiene vigilado.

Para encontrar un ejemplo mas gráfico, imaginen una historia en la que el caballero ha de cruzar un lago en el que vive una gran sierpe que ha roto el puente. En ese momento un mago aparece en escena, congelando el lago junto a la serpiente, permitiendo al caballero cruzar el lugar tras lo cual el mago derrotará a la sierpe y encontrará entre los huevos que custodiaba un mágico amuleto de aspecto siniestro.

\subsubsection{EL Héroe Caído ó Villano}
El concepto de héroe caído, como ya se menciono antes en el capítulo \ref{cap:PrimerosPasos}, es el de un caballero con un corazón malvado que en última instancia decide no salvar a la princesa e intenta acabar con ella. El propósito de este personaje, aparte de cumplir nuestra necesidad de los múltiples objetivos de un mismo agente tal y como se explico en el capítulo \ref{cap:Objetivos}, es el de no clasificar automáticamente a los personajes en ``buenos'' y ``malos'', pues somos partidarios de que las mejores historias cuentan con el elemento inesperado de aquel que parece ser héroe pero sin embargo no lo es.

\subsubsection{Protagonistas Adaptables}
Como se explicó en el capítulo de objetivos, una de nuestras aspiraciones era conseguir que la aplicación fuese altamente personalizable haciéndola lo menos restrictiva posible.
Para ello, decidimos que los Protagonistas pudiesen ser configurados mediante un archivo XML. Este archivo nos brindó la oportunidad de crear clases menos específicas, que se adaptasen a mas entornos y en definitiva fuesen mas genéricas, para ello cambiamos el nombre de las clases explicadas anteriormente pudiéndose ver el resultado en la tabla \ref{fig:TablaClasesProtagonistas}.

\begin{table}[h!]
	\centering
	\begin{tabular}{l|l}
		Clase Protagonista				& Papel en la Historia  \\ \hline
		Víctima (Princesa)	& Será secuestrada en las historias \\
		Allegado a la Víctima (Rey) 	& Pedirá que rescaten a la víctima\\
		Aspirante a Héroe (Caballero) 	& Irá al rescate de la víctima \\
		Ayudante del Héroe (Mago)		& Ayudará al héroe en un momento crítico \\ \hline
	\end{tabular}
	\caption{Tabla final de Clases de Protagonistas y su papel en la historia}
	\label{fig:TablaClasesProtagonistas}
\end{table}

Esta forma permitirá al usuario tener mas flexibilidad a la hora de concretar los parámetros de su historia, de manera que puede elegir que uno de los héroes en su historia sea el caballero Don Quijote embarcado en el peligroso rescate de la princesa Dulcinea o que el samurai Kenshin deba rescatar a Mulán, la hija del emperador. 

%-------------------------------------------------------------------


\subsection{Implementación de los Protagonistas}
Para poder desarrollar de manera eficiente los protagonistas hubo que realizar numerosas tareas en la aplicación, ya que en parte, partíamos de cero, tal y como se explicó en el capítulo \ref{cap:PrimerosPasos}. Esto nos llevo a necesitar de distintas clases para poder cumplir los objetivos que se explican a lo largo del capítulo.

De igual manera, cada acción que aquí se comenta, como que la víctima pide ser rescatada, aparecerá en la historia, pero eso se ve con detalle en \ref{cap:Simulaciones}.

%-------------------------------------------------------------------
\subsubsection{Carga y Configuración de los Protagonistas}
Para poder tener unos protagonistas tan diversos necesitábamos de algo capaz de interpretar correctamente los datos de estos. Para ello se uso un SCD. Este SCD era capaz de cargar e interpretar los datos proporcionados a través del fichero ``Personajes.XML'', a partir del cual cogía las características concernientes a cada Protagonista en específico y proporcionaba al agente mundo esos datos, recorriendo en el archivo todos los nodos con la palabra clave \texttt{<personaje>}.
El archivo de configuración tenía al final el aspecto del cuadro \ref{protagonistasXML}.

\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de los protagonistas},label=protagonistasXML]

<?xml version="1.0" encoding="UTF-8"?>
<Actores>
	<personaje nombre="[nombrePersonaje]" clase="[nombreClase]"
		raza="[nombreRaza]" vida="[#]" 
			fuerza="[#]" destreza="[#]" inteligencia="[#]" 
				codicia="[#]"/>
</Actores>
\end{lstlisting}
%\label{ejemploXML:protagonistas}
%\begin{lstlisting}[basicstyle=\tiny]
%	<personaje nombre="Felipe" clase="Rey" raza="LUCS" vida="100" fuerza="10" destreza="1" inteligencia="1" codicia="1"/>
%	<personaje nombre="Leia" clase="Princesa" raza="LUCS" vida="10" fuerza="10" destreza="1" inteligencia="1" codicia="1"/>
%	<personaje nombre="Alonso" clase="Caballero" raza="TESQ" vida="10" fuerza="10" destreza="1" inteligencia="1" codicia="1"/>
%\end{lstlisting}
 
\subsubsection{La Clase Protagonistas}
Para poder ejecutar correctamente a los protagonistas se necesita de una interfaz común para poder tratarlos a todos como el tipo de personajes que son.
Esta interfaz interpreta correctamente los datos cargados desde el SCD de los protagonistas, para posteriormente enviarlos a cada clase en específico. Esta clase, que hereda a su vez de la clase de personajes, tiene los atributos específicos de los protagonistas, y representa una gran ayuda a la hora de la implementación de estos.
%aquí pondría el diagrama de esta interfaz
Una vez entendido bien el por que necesitamos de una interfaz común a todos los protagonistas, procederemos a explicar uno por uno como fueron realizados.


\subsubsection{La Víctima} 
La ejecución de la clase empieza cargando los atributos y datos específicos del agente. Tras esto, es necesario imponer a la víctima un pariente, consultando al DF por aquellos agentes que registraron el servicio \texttt{Rey}, tras lo cual la víctima registra el servicio \texttt{Secuestrable} en el DF. %la princesa se localiza en el castillo del padre?
Aparte de esto posee tres comportamientos.

El comportamiento \texttt{mover-secuestrada} permite a la princesa moverse con su secuestrador, respondiendo al mensaje ACL \texttt{mover princesa}. Aunque a los ojos de la historia es el captor quien manda moverse a la víctima, el agente solo puede relocalizarse en el mapa a sí mismo, así que realmente se mueve por su propio pie, aunque, eso si, siguiendo las ordenes de su captor.

La víctima será raptada por un antagonista del tipo \textit{Secuestrador}. Cuando la víctima es secuestrada, llega un momento en el que su captor la manda el mensaje ACL \texttt{Te Secuestro}, que le confirma que en efecto ha sido raptada. En ese momento la víctima lanza una petición de ayuda que es recogida por el pariente que se le había asignado.
Una vez esto ocurre la víctima intenta escaparse por sus propios medios. 
Para ello la víctima usa un comportamiento \texttt{TickerBehaviour} que envía cada X periodo de tiempo la petición \texttt{mujerIndependiente}, a través de un mensaje ACL del tipo \texttt{Request} a su secuestrador. Este mensaje contiene un numero aleatorio generado en cada periodo, que se encuentra en el rango de los valores de vida de su captor. Cuando el captor recibe el mensaje, evalúa si el numero recibido es mayor que su valor de vida actual ya que ante un secuestrador malherido, contaría con muchas más posibilidades de escapar. Si finalmente el número es mayor, la víctima consigue liberarse, informa al \textit{Aspirante a Héroe} de que ya no necesita ser salvada y se planifica, tras lo que termina su ejecución.

Por último, tiene el comportamiento \texttt{rescatada}, que se ejecuta cuando es salvada, es decir, no se ejecuta cuando escapa por su propio pie. En este comportamiento, la víctima espera un mensaje ACL del tipo \texttt{Inform} con el ID \texttt{Rescatada}, que será lanzado por su salvador, indicando a la víctima el fin de su ejecución. 


\subsubsection{El Allegado a la Víctima}
% contar como se inicia y carga sus datos. Funciona como una maquina de estados (mirar en la otra memoria)
Al iniciarse el agente se carga un número aleatorio de víctimas a las que puede estar ligado, seguido de los datos específicos del agente, con la particularidad de que también carga su salario específico, cualidad que usa el agente para contratar los servicios de los héroes dispuestos a salvar a la víctima, normalmente superior al del resto de personajes. Si el número de víctimas a las que puede estar ligado es cero, el agente se destruye.

%quitable la siguiente frase
Una vez comprobado que no existe ningún problema con los datos cargados, el agente se localiza, tras lo que registra el servicio \texttt{Rey} y comienza su ejecución, incorporando dos comportamientos, \texttt{Tortura}, en el que se ve enfrentado al antagonista Asesino, y un \texttt{FSMBehaviour}.

En el comportamiento específico de \texttt{Tortura}, el agente evalúa si recibe el mensaje ACL \texttt{Agoniza} de un asesino, y en caso afirmativo empieza la ejecución de un \texttt{TickerBehaviour} que le va restando vida al agente progresivamente. En caso de que la vida llegue a cero, el comportamiento finalizará la ejecución del agente.

A partir de aquí el funcionamiento del rey es ciertamente delicado. La ejecución del comportamiento \texttt{FSMBehaviour} se asemeja a la de una máquina de estados circular, donde cada comportamiento se ejecutará dando paso al siguiente. Para poder ejecutarse correctamente ha de registrar los diferentes estados, añadiendo a cada estado el comportamiento correspondiente e identificándolos por un nombre específico, y después añadirá las transiciones, que especifican el cambio entre estados.
Los diferentes estados por los que puede pasar el agente son:
\begin{itemize}
	\item \textbf{Atento}: En el estado atento, el agente esta esperando a recibir un mensaje ACL del tipo \texttt{Request} proveniente de la víctima. Cuando este mensaje se produce, el agente activa a un único antagonista del tipo \textit{Asesino}, elegido de forma aleatoria, a través de un mensaje ACL del tipo \texttt{Inform} con el ID \texttt{Derrocar}.
	\item \textbf{Rescate}: En este estado el agente busca en las paginas amarillas a aquellos agentes con el servicio \textit{Matadragones}, que serán los aspirantes a héroes, buscando al menos uno disponible.
	\item \textbf{Ayuda}: Aquí se registra un mensaje ACL del tipo \texttt{CFP}, que se envía a todos aquellos agentes encontrados en el estado anterior a través del \texttt{MessageTemplate Solicitar Servicio}.
	\item \textbf{Recibir Oferta}: El agente recibe la respuesta de cada \textit{Aspirante a Héroe} a la petición del estado anterior a través de un mensaje ACL. En este mensaje, se incluye el precio por contratar sus servicios de cada aspirante, tras lo que el \textit{Allegado} elige aquel con la mejor oferta, el precio mas bajo. Si no posee suficiente dinero para pagar a un nuevo aspirante, volverá a buscar aspirantes nuevos comprobando nuevamente si cumplen los requisitos necesarios.
	\item \textbf{Aceptar Oferta}: Al aspirante seleccionado finalmente en el anterior estado, el \textit{Allegado} le manda un mensaje ACL del tipo \texttt{AcceptProposal}, en el que le proporciona los datos de la víctima y del secuestrador, de manera que el aspirante a héroe sea capaz de planificarse para rescatar a la víctima. Tras esto el agente espera una respuesta del aspirante en forma de mensaje ACL. Si este mensaje es del tipo \texttt{Inform} implica que el aspirante tuvo éxito en su empresa. Si no, significa que falló, y el \textit{Allegado} volverá a buscar nuevos aspirantes.
	\item \textbf{Salvada}: En este estado el \textit{Allegado} envía un mensaje ACL de tipo \texttt{Inform} a la víctima, indicándole que ha sido rescatada, y eliminándola de la lista de víctimas ligadas al \textit{Allegado}. Si esta lista de víctimas queda vacía o el agente se queda sin dinero su ejecución terminará. Si no, volverá al estado inicial, Atento.
\end{itemize}

\begin{figure}[h]
	\centering
	\includegraphics[width=0.8\textwidth]{Imagenes/DiagramaEstadosRey}
	\caption{Diagrama de transición autómata del Allegado}
	\label{fig:DiagramaEstadosRey}
\end{figure}




\subsubsection{El Aspirante a Héroe}
Al iniciarse un nuevo aspirante, éste carga todos sus atributos, registra el servicio \texttt{Matadragones} y se localiza dentro del mapa.  El agente registra dos comportamientos principales que son el comportamiento \texttt{OfrecerServicios()} y el comportamiento \texttt{AceptarOfertaRescate()}.

En el comportamiento \texttt{OfrecerServicio()}, el héroe espera un mensaje ACL del tipo \texttt{SolicitarServicio} que mandará el \textit{Allegado a la Víctima} cuando quiera que alguien salve a la víctima. A ese mensaje el héroe responde enviando una propuesta, en forma de mensaje ACL del tipo \texttt{Propose}, indicando cuanto cuesta contratar sus servicios, que viene determinado por su codicia (véase el capitulo \ref{cap:AtributosRazas}).

Si esta propuesta es aceptada accederá a su siguiente comportamiento, \texttt{AceptarOfertaRescate}. En este momento le llega la información necesaria para cumplir el contrato, véase los datos del \textit{Secuestrador} y de la \textit{Víctima} que ha de salvar. Tras esto, informa con el mensaje ACL \texttt{ObjetivoSecuestro}, un mensaje de control del entorno que refleja que víctima salvará el héroe, y se planifica.
%donde sus objetivos serán estar con la princesa en su casa y posteriormente convertirse en héroe, para lo que debe volver a su propia casa.
Será dependiendo de su planificación cuando se decide si el aspirante a héroe acaba siendo un héroe o si sin embargo, harto de la princesa, decide convertirse en villano.

Si decide convertirse en héroe, el agente deberá enfrentarse al \textit{Secuestrador} en batalla y en caso de vencer escoltará a la \textit{Víctima} hasta su hogar, tras lo que el aspirante vuelve a su propia casa y se convierte finalmente en héroe.

Si decide convertirse en villano, el agente deberá enfrentarse al \textit{Secuestrador} en batalla y en caso de vencer entablará batalla con la \textit{Víctima} intentando acabar con ella, donde si lo consigue se convierte finalmente en villano.

Independientemente de la elección el agente acaba su planificación y termina su ejecución.

Si en algún momento la víctima logra escapar por si sola, el agente parará su ejecución y se replanificará con el objetivo de volver a casa.

Para el funcionamiento de la batalla, los personajes restan la suma de su vida y su atributo principal a la vida de su contrincante, mientras que los antagonistas restan directamente su vida. Aquel que consigue que la vida de su oponente sea menor que cero sería el vencedor. En caso de que ambos lo consigan, ambos mueren.

También es importante indicar que cada vez que el agente se mueve por el mapa de una localización a otra, el entorno consulta a los antagonistas \textit{Guardianes} y \textit{Emboscadores} si les interesa interactuar en esta nueva localización con este agente. Esto se ve con mas detalle en sus capítulos respectivos.

\subsubsection{El Ayudante del Héroe}
%recoge datos, servicio cazamagia
%1 solo comportamiento, en el que espera que alguien le avise, y en ese momento se planifica
%-------------------------------------------------------------------




\section{Antagonistas}
Para que la historia tenga sentido siempre debe haber algo que motive a los protagonistas a emprender sus acciones. Para cumplir este fin surge la figura del Antagonista, un personaje malvado con motivaciones que van en contra de aquellas que definen la manera de actuar de los protagonistas.

%-------------------------------------------------------------------

\subsection{Diseño de los Antagonistas}
Para diseñar los antagonistas se decide también que la mejor manera es clasificarlos según las distintas acciones que finalmente serán capaces de realizar, por tanto también se decide separarlos por clases capaces de diferenciar a los Antagonistas de una manera similar a lo propuesto con los Protagonistas. Las elecciones finales se explican en detalle a continuación.

\subsubsection{El dragón}
El Dragón representa un personaje primordial en la historia. Al principio de la historia todo transcurre apaciblemente hasta que el dragón despierta, se inicia el agente, y busca una víctima que pueda secuestrar, en ese momento el dragón decide llevar a cabo el rapto dando pie a todos los acontecimientos que se suceden después, es decir, provocando que el rey avise a los caballeros y estos se muevan a través del mapa, que conforman el nudo de la historia.


%-------------------------------------------------------------------
\subsubsection{Creando nuevos Antagonistas}
Una de las propuestas mas estudiadas es que nuevos héroes implicaban nuevos antagonistas. Sin embargo, estos nuevos antagonistas no pueden ser el mismo antagonista llamado de manera distinta (no nos sirve la idea de tener un grifo y un dragón y que los dos hagan lo mismo), y de igual manera no queremos introducir un nuevo tipo de antagonista con la capacidad de suplantar al dragón como elemento primordial en la historia.

El primer enfoque explora el incluir antagonistas ligados a un lugar, es decir, antagonistas que vigilen un lugar específico del mapa y que castiguen a los \textit{Aspirantes a Héroes} que deciden atravesar ese camino para completar su aventura. De esta manera, se crean localizaciones concretas y antagonistas específicos para ellas.

La primera localización elegida es el lago. En el lago puede vivir una Serpiente Marina, aunque en este caso fuese de agua dulce, que ataque a los aventureros que se atrevan a cruzarlo, con el objetivo de derrotarlos y que las aguas del lago descansen tranquilas siempre sin que nada las perturbe.

La segunda localización que aprobada es el cruce. En este cruce de múltiples caminos, un avaricioso Trol monta guardia pidiéndole a los confiados viajeros los tributos necesarios para poder continuar su camino. Los viajeros deben pagar el tributo o sino se enfrentarán a la ira del malvado Trol.

Como tampoco se busca que los nuevos antagonistas se limiten a no dejar pasar a los aspirantes a héroe, se introduce un nuevo antagonista que no interactua necesariamente con ellos, y así nace el concepto del Fantasma.

El Fantasma es el espíritu vengativo de un rey derrocado hace tiempo que no pudo saciar sus ansias de poder. Así su cometido será vagar por los castillos, buscando aquellos monarcas en los que la desesperación ha hecho mella, como aquellos con una hija secuestrada, alimentándose de su desesperación y conduciéndolos a la locura, lo que implicaba un descenso progresivo en sus puntos de vida.

\subsubsection{Antagonistas genéricos}
Como sucede a lo largo del proyecto, al tratar de darle un aire mas genérico a los antagonistas decidimos que estos también deben ser configurados por el usuario a través de un archivo XML. Para ello la clasificación de los antagonistas dentro del sistema cambia, y pasamos a tener antagonistas secuestradores (dragón), emboscadores (trol), guardianes (serpiente) y asesinos(fantasma). Esta nueva clasificación permite que los antagonistas trabajen bajo las condiciones con las que antiguamente estaban diseñados pero que a su vez no tengan por que ser un antagonista impuesto por nosotros. El esquema final sería algo así:

\begin{table}[h!]
	\centering
	\begin{tabular}{l|l} 
		Antagonista					& Objetivo \\ \hline
		Secuestrador				& Secuestrar Víctimas \\
		Emboscador 					& Emboscar Héroes a cambio de dinero\\
		Guardian 					& Proteger un Objeto \\
		Asesino						& Atormentar Allegados a Víctimas \\ \hline
	\end{tabular}
	\caption{Tabla final de objetivos y tipos de Monstruos}
	\label{fig:TablaObjetivosMonstruos}
\end{table}

De esta manera el usuario a través del archivo XML, cuya construcción es consultable en el esquema \ref{antagonistasXML}, podrá dictaminar el nombre del antagonista, que clase de antagonista dentro de los tipos propuestos quiere que sea, que especie desea otorgarle y finalmente definir su sexo. Así, por poner algunos ejemplos, el usuario podrá elegir que la princesa Rapunzel sea secuestrada por el dragón Smaug o por la bruja Maléfica, o, de la misma manera, que el dragón Smaug secuestre princesas en una simulación del sistema o bien embosque a los viajeros que atraviesan la Montaña Solitaria.
%-------------------------------------------------------------------
\subsection{Implementación de los Antagonistas}
Para implementar los Antagonistas se necesita tratar con agentes y sus propiedades. A través del agente mundo los agentes se comunican con otros agentes y reciben la información que necesitan. Pero sin embargo para el correcto funcionamiento de los Antagonistas se necesitan muchas más cosas.
%-------------------------------------------------------------------
\subsubsection{Carga y configuración de los antagonistas}
Al crear el SCD de Antagonistas, capaz de cargar los datos correctamente del archivo ``Monstruos.XML'', se sigue el patrón preestablecido en el capítulo \ref{cap:Arquitectura:Loaders} con la particularidad de recorrer los nodos con la palabra clave <monstruo>, que contienen los atributos específicos de cada antagonista que se quiere introducir en la historia. El archivo XML seguía mas o menos esta estructura:

\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de los antagonistas},label=antagonistasXML]

<?xml version="1.0" encoding="UTF-8"?>
<Actores>
	<monstruo nombre="[nombreAntagonista]" 
		clase="[Secuestrador|Guardian|Emboscador|Asesino]"
			especie="[nombreEspecie]" sexo="[M|F]"/>
</Actores>
\end{lstlisting}


%-------------------------------------------------------------------
\subsubsection{La Clase Antagonistas}
La Clase Antagonistas es aquella capaz de interpretar correctamente un agente mandado desde el SCD de antagonista. Esta Clase a su vez necesita de la Clase Personaje (ver capítulo \ref{cap:Arquitectura:InterfazPersonajes}), donde conseguía cargar todos los atributos relativos al antagonista, como que era, donde estaba o cuanta vida tenía, y finalmente le dejaba el trabajo a la clase en cuestión que se encargaba de ese tipo antagonistas en específico.
%aquí pondría el diagrama de esta interfaz
A continuación entraremos en detalle a explicar como se implementó cada antagonista en específico.
Para explicar de manera correcta como se comportaban este tipo de antagonistas explicaremos que comportamientos y acciones es capaz de desarrollar como agente.
%-------------------------------------------------------------------

\subsubsection{El Antagonista Secuestrador}
Según se inicia el agente secuestrador este solicita información al agente Mundo. En este caso el Mundo le tiene que indicar cuales son aquellos agentes que proporcionan el servicio \texttt{Secuestrables} y, en caso de que no hubiese ninguno el agente se queda a la espera de que aparezca uno que cumpla los requisitos solicitados.

En caso de encontrar al menos uno de los agentes con el servicio secuestrable, escoge entre ellos de manera aleatoria eligiendo será su objetivo, registrando el mensaje ACL \texttt{ObjetivoSecuestro}. Una vez ha escogido el agente a secuestrar se planifica, incorporando a su funcionamiento los servicios de \texttt{FalloSecuestro}, que entra en acción cuando falla en el rapto, y \texttt{FinDePlanificación}, que se ejecuta cuando el secuestro se realiza correctamente.

Cuando se ha producido un error durante el secuestro el agente informará al agente Mundo del mismo, a través de un \texttt{MessageTemplate}, tras lo cual parará su ejecución y volverá al punto inicial, es decir que esperará a que aparezca algún agente secuestrable.

Sin embargo, cuando el secuestro se realiza con éxito, el agente secuestrador finaliza correctamente su ejecución. En ese momento informa al agente Mundo y registra el mensaje ACL \texttt{Te secuestro}, informando así al agente \textit{Víctima} que ha secuestrado de que en efecto ha sido raptado. Por último, vuelve a su guarida, donde esperará con el agente \textit{Víctima} a que alguien venga a por él y finalmente registrará el comportamiento \texttt{HayQueJoderseConLaPrincesita}.

Este comportamiento permite al agente \textit{Víctima} secuestrado escaparse de su raptor. Para ello, la víctima ejecuta una tirada aleatoria entre los valores posibles de vida de su captor. Cuando el resultado de su tirada es mayor que la vida actual de éste escapará, lo cual implica que es mucho mas fácil escapar de un captor malherido que de uno que aún conserve todas sus fuerzas.
%-------------------------------------------------------------------
\subsubsection{El Antagonista Emboscador}
El agente emboscador se registra enviándole al mundo la información relativa a su tipo, a través de un DFAgentDescription que lo identificaba como "emboscador", tras lo cual registra los comportamientos de Emboscar y Acecho y finalmente se planifica.

El comportamiento de Emboscar es bastante complejo. 
Lo primero que se debe contemplar es que el agente \textit{Emboscador} ha sido colocado en el mundo, consultar el capitulo de Mapa \ref{cap:Mapa:LocalizacionesAleatoriasSegunClase} para conocer como, en la localización donde realiza sus emboscadas y que solo embosca a personajes de una clase en específico, en este caso los \textit{Aspirantes a Héroe}.
Tras esta aclaración se explica como funciona el comportamiento de Emboscar.

El agente emboscador le envia el \texttt{MessageTemplate Solicitar Servicio} al mundo, a la vez que elegía un tipo de clase de protagonista a la cual iba a emboscar. Cada vez que un agente se mueve, el agente \textit{Mundo} busca entre todos los agentes emboscadores, mandandoles la clase del agente que acaba de moverse.
En caso de que uno o varios agentes emboscadores busquen esta clase, enviarán una propuesta, a través de un mensaje ACL del tipo \texttt{Propossal}, al \textit{Mundo} junto a su localización. Si la localización de ambos agente no coincide, no ocurrirá nada y el agente que se esta moviendo sigue su camino. Si, sin embargo, la localización de ambos agentes es la misma, el \textit{Mundo} acepta la propuesta del agente \textit{Emboscador} y le proporciona la información del agente que se esta desplazando por esa localización.

Una vez que la propuesta del agente \textit{Emboscador} ha sido aceptada, da comienzo el comportamiento \texttt{Acechar}, gracias a que dentro de este comportamiento se necesita la respuesta al mensaje cruzar que proporciona el comportamiento anterior, que viene en forma de \texttt{MessageTemplate}.

En el comportamiento Acechar, el \textit{Emboscador} tiene los datos del agente al que esta emboscando, proporcionados por el agente \textit{Mundo}. De esta manera genera un random con el dinero que le pedirá al otro agente, con el que inicia una conversación con el ID \texttt{Hacienda}. Si el otro agente tiene el dinero suficiente paga y pasa sin problemas, y sino, el \textit{Emboscador} lo mata.

%-------------------------------------------------------------------
\subsubsection{El Antagonista Guardián}
%Declara su tipo como guardian y se planifica, yendo a buscar un pobjeto aleatorio para custodiarlo. En ese momento espera el encuentro con un caballero y es que, cuando un caballero pase por su guarida, el guardian se enfrentara a el para protegercon recelo su objeto. En ese momento el guardian despertara la actividad del mago que vendra en ayuda del caballero.



%-------------------------------------------------------------------
\subsubsection{El Antagonista Asesino}
%registra su tipo como asesino, añade el comportamiento maldad a partir del cual lanzara el mensaje derrocar, el rey cuya princesa ha sido secuestrada esta debil y es por tanto derrocable, asi que en ese momento el asesino se planifica.


%-------------------------------------------------------------------




\section{PNJ}
\begin{quote}
	\textit{Los PNJ's son personajes del juego que son controlados por el sistema y que son capaces de interactuar con el avatar del jugador intercambiar artículos e información}\cite{GomezGauchiaPeinadoTIDSE06}.
\end{quote}
En el sistema hemos adaptado estos personajes de los juegos a la narrativa para conseguir mayor diversidad de historias generadas.
%-------------------------------------------------------------------

\subsection{Diseño de los PNJ's}
Nuestro numero de historias ya es altamente variado, pero aun así sentimos que debemos proponer más. En busca de un nuevo aire que diese un toque distinto a las historias y aumentase en cantidad el número posible de estas, propusimos la idea de unos personajes simples, parecidos a los agentes objetos que en un principio queríamos evitar, que con una acción sencilla cambien ligeramente el curso de la historia o que sencillamente aparezcan en ella dándole un toque divertido a ésta.

Para ello se propuso crear numerosos personajes, que tuviesen como peculiaridad el interactuar con los protagonistas cuando éstos pasan por las localizaciones en las que están situados. En ese momento se producirá un pequeño diálogo entre ambos personajes, otorgándole el PNJ un objeto, \ref{cap:Objetos:ObjetosPNJ}, al personaje principal. A este aspecto dentro de la historia lo denominaremos como \texttt{bufo}. Éste \texttt{bufo} bien puede ser un objeto que se consume en el momento o una bendición que afecta al personaje modificando sus atributos, ya sea de manera positiva por que se había encontrado con un PNJ amigable o de manera negativa si éste era perverso. 

Para terminar de definir los PNJ's pensamos que lo que mas encaja dentro de nuestra propuesta de diseño es que éstos tengan un oficio. De esta manera, al crear los PNJ's se propone que para definir el objeto con el que interactuaban lo suyo era clasificarlos por su oficio, de manera que se pecide que los PNJ's fuesen herreros, enfermeras o sastres, que vivían en los lugares relacionados con su profesión tal y como se comento en el capitulo de mapa\ref{cap:Mapa:LocalizacionesPNJ} véase la herrería, el hospital o la sastrería y proporcionen este \texttt{bufo} con algo relacionado a su campo, por ejemplo el herrero puede forjar una espada mejor o reestablecer las abolladuras de la armadura del personaje, lo que se acaba representando como una mejora en un atributo del propio personaje, como puede ser la fuerza con la espada o la vida con la armadura. 
De la misma manera, y para que entendamos el concepto de PNJ malévolo, el personaje podría cruzarse con un chamán, que le da una pócima de setas ''bendecidas por los ancestros´´, donde en ciertas simulaciones aumentarán los atributos del personaje, y en otras los disminuirán.

Sin embargo, decidimos que este diseño limitaba a los PNJ's a unos personajes muy específicos con un guión demasiado particular, características que queríamos evitar dentro de nuestra aplicación. De esta forma, se decide que los PNJ's también puedan ser configurables por el usuario a través de ficheros XML que, si se usaban con cuidado, permitirían al usuario personalizar su propia historia.


%-------------------------------------------------------------------
\subsection{Implementación de los PNJ's}
La implementación de los PNJ trajo consigo numerosas adiciones de clases al proyecto. Cada una cumple con una funcionalidad específica, y eran la mejor solución para cumplir satisfactoriamente el papel de los PNJ's dentro de la aplicación.

\subsubsection{PNJ's configurables por el usuario}
Para permitir la configuración de los PNJ's a través de los XML se necesito, como de costumbre, de un SCD capaz de cargar los datos del archivo y almacenarlos correctamente dentro de la aplicación.

Este SCD seguía el diseño normal del resto \ref{cap:Arquitectura:Loaders}, con la particularidad de que carga específicamente el fichero ``PNJs.XML'', donde recorre sus nodos buscando la palabra clave <pnj>. Una vez encontrada, recorre el nodo que representa al propio PNJ almacenando la información referente a su nombre, su sexo, su oficio y su localización, usando esta información para crear un nuevo agente con estas características.
Como con todos los archivos XML, esta configuración exige que el fichero este creado de una manera concreta, consultable en \ref{pnjsXML}, por lo que se incluye en el fichero ``PNJs.XML'' una guía sobre como construir estos agentes, lo mismo que viene rellenado con una información por defecto que también puede usarse como ejemplo.

\lstset{frameround=fttt}
\begin{lstlisting}[basicstyle=\scriptsize,frame=trBL,caption={Formato XML de los PNJ's},label=pnjsXML]
<?xml version="1.0" encoding="UTF-8"?>
<Actores>
	<pnj nombre="[nombrePNJ]" sexo="[M|H]" oficio="[nombreOficio]" 
		localizacion="[nombreLocalización]"/>
</Actores>
\end{lstlisting}

\subsubsection{La Clase PNJ}
Si bien el agente se inicia desde el SCD, para poderse cargar de manera correcta se necesita de una clase capaz de usar correctamente las características específicas de este tipo de agentes. De esta manera se crea la clase PNJ, que hereda de la Case Personajes \ref{cap:Arquitectura:InterfazPersonajes}, donde se incluyen los métodos específicos que permiten el buen funcionamiento de los PNJ's.
