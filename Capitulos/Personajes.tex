%---------------------------------------------------------------------
%
%                          Capítulo 6
%
%---------------------------------------------------------------------

\chapter{Los Personajes}
\label{cap:Personajes}

\begin{FraseCelebre}
\begin{Frase}
\end{Frase}
\begin{Fuente}
\end{Fuente}
\end{FraseCelebre}

Si quieres dar variedad a tu historia esta debe contar con una gran diversidad de personajes, cada uno con sus virtudes y limitaciones, y a cuantos mas personajes haya más posibilidades tendrás de crear diferentes historias, ya que cada uno podría actuar de manera distinta en cada ejecución. 

Con este objetivo en mente propusimos un nuevo diseño para nuestros personajes.
Sin embargo las posibles historias que podamos generar comparten siempre una misma estructura, ya que no puede ser de otra manera. 
Siempre aparecerá un antagonista que logrará secuestrar a la princesa, el rey pedirá ayuda a los distintos aspirantes a héroes y estos acudirán a su llamada intentando salvarla, a partir de lo cuál aparecerán distintos personajes.
Para poder diseñar correctamente estos diversos personajes lo primero que debíamos hacer era concretar unos tipos que definiesen en cierta medida cual sería su manera de participar en la historia. De esta manera decidimos dividir a nuestros posibles personajes en tres tipos concretos, que serían: \texttt{Protagonistas}, \texttt{Antagonistas} y \texttt{Personajes no Jugadores} o \texttt{PNJs}.

De esta manera los \texttt{Protagonistas} llevarían el peso de la historia, representando aquellos personajes con los que el usuario se puede identificar y asumirían el rol de los ``buenos'' dentro de la narración. Los \texttt{Antagonistas}, por su parte, actuarían en contra de los intereses de los protagonistas, proponiendo problemas que estos deben resolver para el transcurso de la historia y asumiendo el papel de ``malos'' en la misma. Por último, los \texttt{PNJs} representarán los personajes secundarios que intervendrían en una narración, modificando la manera en la que esta discurre pero sin llegar a tener un papel clave en la historia, sino mas bien un papel de apoyo u oposición con respecto a los protagonistas.

También es importante indicar que todos los personajes se planificarán en algún momento de su ejecución. Para entender realmente como se planifican y el papel que juega el planificador en su manera de ejecutarse, es recomendable comprender bien el capitulo \ref{cap:Arquitectura:Planificador}.

%aqui yo introduciria el diagrama del que de los personajes salen las 3 clases.

%para las comillas ``inteligencia''



\section{Protagonistas}
Para que la historia fuese rica necesitábamos de no solo uno sino varios personajes principales con los que disponer en el transcurso natural de la historia, pues cuantos mas personajes hubiera, mejores historias podríamos crear. Lo natural en estos casos es que los protagonistas no sean meras copias unos de otros, así que decidimos que dentro de los propios protagonistas debía haber una nueva división de tipos.

\subsection{Diseño de los Protagonistas}
En la búsqueda de unos protagonistas para nuestras historias decidimos partir de aquellos ya planteados, como se ve en \ref{cap:PrimerosPasos}, pero para que estos personajes fuesen originales y pudiesen cumplir papeles diversos en la historia fue necesaria la inclusión del concepto de clase dentro de los protagonistas. Estas clases nos ayudarían a parametrizar los pasos que seguiría cada clase de personajes dentro de la historia y así darles a cada clase ciertas funcionalidades específicas. 
De igual manera, también es importante remarcar que los protagonistas serán los únicos que podrán obtener y consumir recursos, tal y como se explica en el capítulo de objetos \ref{cap:Objetos}.
Las distintas clases a las que un protagonista puede pertenecer son:

\subsubsection{La Princesa}
La Princesa cumplía un rol muy importante dentro de nuestras historias. Ella siempre era raptada por un antagonista y a partir de ese momento desencadenaba la acción de los distintos protagonistas repartidos por el mundo, y las diversas pruebas por las que debían pasar hasta que por fin fuese salvada.
Sin embargo, nuestra idea del personaje ``Princesa'' no acababa ahí, sino que también queríamos que fuese un personaje capaz de actuar por iniciativa propia. Por tanto, en nuestra búsqueda de la princesa fuerte e independiente, decidimos que ésta también fuese capaz de escapar por su propio pie. Así, cuando los caballeros se demoraban demasiado, la princesa se iba impacientando mientras evaluaba sus posibilidades de éxito, hasta que finalmente decidía emprender la huida por su cuenta. Esto no quiere decir que la princesa se escapase siempre, simplemente a veces lo conseguía y a veces no.

\subsubsection{El Rey}
El Rey cumplía un papel mas formal dentro de la historia. Su principal uso era el de tener un personaje intermedio para que los distintos personajes se pudiesen comunicarse entre sí, pero no por ello era menos importante, ya que sin su ayuda la historia no podría transcurrir de manera fluida.
La empresa del rey era la de contratar a los distintos caballeros del reino cuando alguna de sus hijas era secuestrada. Así, el Rey les pedía ayuda a estos aspirantes a héroes con la esperanza de que alguno pudiese rescatar a su preciada hija.

\subsubsection{Los Caballeros}
El propósito de los Caballeros en la historia era cumplir el papel de héroes. Para ello debían emprender su camino con el objetivo de rescatar a la princesa de su malvado secuestrador, enfrentándose por el camino a las distintas pruebas propuestas por el resto de los antagonistas.
En estas pruebas el caballero deberá hacer uso de los diversos recursos que tenga a su alcance, que representaremos mediante los objetos, o incluso necesitará ayuda de otros personajes para poder superarlas, que forman parte de la historia como otros protagonistas.

\subsubsection{El Mago}
El Mago cumplirá el papel del personaje que ayuda en un momento crucial de la historia al héroe de la misma. La forma de funcionar de este personaje se entiende cuando el caballero tiene un encuentro con un antagonista en específico, en este caso el guardián.
El caballero, que por si solo no es capaz de enfrentarse al guardián, pedirá apoyo a un mago, el cual acudirá en su ayuda bajo el precio de poder quedarse con el objeto que este antagonista guardián mantiene vigilado.

Para encontrar un ejemplo mas gráfico, imaginen una historia en la que el caballero ha de cruzar un lago en el que vive una gran sierpe que ha roto el puente. En ese momento un mago aparece en escena, congelando el lago junto a la serpiente, permitiendo al caballero cruzar el lugar tras lo cual el mago derrotará a la sierpe y encontrará entre los huevos que custodiaba un mágico amuleto de aspecto siniestro.

\subsubsection{EL Héroe Caído o Villano}
El concepto de héroe caído, como ya se menciono antes, \ref{cap:PrimerosPasos}, es el de un caballero con un corazón malvado que en última instancia decide no salvar a la princesa e intenta acabar con ella. El propósito de este personaje, aparte de cumplir nuestra necesidad de los múltiples objetivos de un mismo agente tal y como se explico en el capitulo de \ref{cap:Objetivos}, es el de no clasificar automáticamente a nuestros personajes en ``buenos'' y ``malos'', pues somos partidarios de que las mejores historias cuentan con el elemento inesperado de aquel que parece ser héroe pero sin embargo no lo es.

\subsubsection{Protagonistas Adaptables}
Como se explicó en el capítulo de objetivos, una de nuestras aspiraciones era conseguir que la aplicación fuese altamente personalizable haciéndola lo menos restrictiva posible.
Para ello, decidimos que los Protagonistas pudiesen ser configurados mediante un archivo XML. Este archivo nos brindó la oportunidad de crear clases menos específicas, que se adaptasen a mas entornos y en definitiva fuesen mas genéricas, para ello cambiamos el nombre de las clases explicadas anteriormente pudiéndose ver el resultado en la figura \ref{fig:TablaClasesProtagonistas}.

\begin{table}[h!]
	\centering
	\begin{tabular}{l|l}
		Clase Protagonista				& Papel en la Historia  \\ \hline
		Damísela en apuros (Princesa)	& Será secuestrada en las historias \\
		Allegado a la Damisela (Rey) 	& Pedirá que rescaten a la damisela\\
		Aspirante a Héroe (Caballero) 	& Irá al rescate de la damisela \\
		Ayudante del Héroe (Mago)		& Ayudará al héroe en un momento crítico \\ \hline
	\end{tabular}
	\caption{Tabla final de Clases de Protagonistas y su papel en la historia}
	\label{fig:TablaClasesProtagonistas}
\end{table}

Esta forma permitirá al usuario tener mas flexibilidad a la hora de concretar los parámetros de su historia, de manera que puede elegir que uno de los héroes en su historia sea el caballero Don Quijote embarcado en el peligroso rescate de la princesa Dulcinea o que el samurai Kenshin deba rescatar a Mulán, la hija del emperador. 

%-------------------------------------------------------------------


\subsection{Implementación de los Protagonistas}
Para poder desarrollar de manera eficiente los Protagonistas hubo que realizar numerosas tareas en la aplicación, ya que en parte, partíamos de cero, tal y como se explicó en el capitulo \ref{cap:PrimerosPasos}. Esto nos llevo a necesitar de distintas clases para poder cumplir los objetivos que a continuación se detallan.

De igual manera, cada acción que aquí se comenta, como que la princesa pide ser rescatada, aparecerá en la historia, peor eso se ve con detalle en \ref{cap:Simulaciones}.

%-------------------------------------------------------------------
\subsubsection{Carga y Configuración de los Protagonistas}
Para poder tener unos Protagonistas tan diversos necesitábamos de algo capaz de interpretar correctamente los datos de estos. Así nació el concepto del Sistema de Carga de Datos (SCD), cuyo diseño se puede ver en profundidad en el capitulo \ref{cap:Arquitectura:Loaders}. Este SCD era capaz de cargar e interpretar los datos proporcionados a través del fichero ``Personajes.XML'', a partir del cual cogía las características concernientes a cada Protagonista en específico y proporcionaba al agente mundo esos datos, recorriendo en el archivo todos los nodos con la palabra clave \texttt{<personaje>}.
El archivo de configuración tenía al final el aspecto de la figura \ref{ejemploXML:protagonistas}.

\label{ejemploXML:protagonistas}
\begin{lstlisting}[basicstyle=\tiny]
	<personaje nombre="Felipe" clase="Rey" raza="LUCS" vida="100" fuerza="10" destreza="1" inteligencia="1" codicia="1"/>
	<personaje nombre="Leia" clase="Princesa" raza="LUCS" vida="10" fuerza="10" destreza="1" inteligencia="1" codicia="1"/>
	<personaje nombre="Alonso" clase="Caballero" raza="TESQ" vida="10" fuerza="10" destreza="1" inteligencia="1" codicia="1"/>
\end{lstlisting}
 
\subsubsection{La Interfaz Protagonistas}
Para poder ejecutar correctamente a los protagonistas necesitábamos de una interfaz común para poder tratarlos a todos como el tipo de personajes que eran.
Esta interfaz interpretaba correctamente los datos cargados desde el SCD de Protagonistas, para posteriormente enviárselos a cada clase en específico. Esta clase, que heredaba a su vez de la interfaz de personajes \ref{cap:Arquitectura:InterfazPersonajes}, tenía los atributos específicos de los Protagonistas, y representaba una gran ayuda a la hora de la implementación de estos.
%aquí pondría el diagrama de esta interfaz
Una vez entendido bien el por que necesitábamos de una interfaz común a todos los protagonistas, procederemos a explicar uno por uno como fueron realizados.


\subsubsection{La Víctima}
%se crea cargando todos sus atributos y datos, elige un padre aleatorriamente para ella, reyenando un array con aquellos de tipo rey, tras lo cual se declara secuestrable. A continuacion realiza un comportamiento que la permite moverse mientras esta siendo secuestrada, siguiendo a su secuestrador respondiendo al mensaje mover-princesa. Otro comportamiento para avisar a su padre de que ha sido secuestrada cuando llega a la guarida del dragon, pues esta esperando al mensaje "te secuestro". En este mismo behaviour lanzara el mensaje mujer independiente cada cierto tiempo, que realiza una tirada aleatoria entre todas las posibles vidas del monstruo, tras lo cual si la tirada es mayor se escapa. Por ultimo tiene un comportamiento para cuando es rescatada en el que informa de que ha sido rescatada y acaba su ejecucion como agente. 
La ejecución de la clase empezaba cargando los atributos y datos específicos del agente. Tras esto, era necesario imponer a la víctima un pariente, que se escogía se manera aleatoria accediendo a un \textit{String} donde estaban todos aquellos agentes de la clase pariente, tras lo cual la princesa declarará del tipo secuestrable. %la princesa se localiza en el castillo del padre?
Aparte de esto poseía tres comportamientos.

El comportamiento \texttt{mover-secuestrada} permitía a la princesa moverse con su secuestrado, respondiendo al mensaje mover princesa. Aunque a los ojos de la historia es el captor el que manda moverse a la víctima, el agente solo podía relocalizarse en el mapa a sí mismo, así que realmente se movía por su propio pie, aunque, eso si, siguiendo las ordenes de su captor.

Cuando la víctima era capturada, llegaba un momento en el que su captor la mandaba el mensaje ``Te Secuestro''. que la confirmaba que en efecto había sido raptada. En ese momento la víctima lanzaba una petición de ayuda que era recogida por el pariente al iniciarse se la había ligado.
Una vez esto ocurría la víctima intentaría escaparse por sus propios medios. Para ello, le lanzaba la petición \texttt{mujerIndependiente} a su secuestrador y se añadia otro comportamiento dentro de este, en el que cada cierto tiempo, un tic de reloj, la princesa generaba un numero aleatorio entre todos los posibles valores de vida que podía tener su captor. Así, si este número era mayor que la vida actual de su captor, ya que ante un secuestrador malherido, contaría con muchas mas posibilidades de escapar, la víctima conseguía liberarse y lanzaba el mensaje de ``liberada''. Tras esto, la princesa se planificaba, con el objetivo de volver a casa.

Por último, tenía el comportamiento \texttt{rescatada}, que se ejecutaba cuando era salvada. En ese momento su salvador la mandaba el mensaje "rescatada" que indicaba a la princesa que su ejecución había acabado y el agente ``moría''. 

\subsubsection{El Allegado a la Víctima}
%


\subsubsection{El Aspirante a Héroe}
%El Caballero se inicia con todos sus atributos y registra el el tipo Matadragones. Tras esto registrara el comportamiento Ofrecer Servicios, en el que espera un mensaje del tipo Solocitar Servicio, si escucha este mensaje enviará su propuesta. Si esta propuiesta es aceptada accedera a su sigueinte comportamiento, que se llama aceptar oferta de rescate. Le llega el array de Strings contratos proporcionados por mundo (creo pero no lo encuentro) que contiene los datos del dragon y la princesa que ha de salvar. en ese momento inorma conel mensaje objetivosecuestro que va a intentar salvar a la princesa. Tras esto se planifica y añade el comprotamiento fin planificacion.En la planificación debera cumplir sus objetivos de objetivos.xml tal y como se explican en el apartado del planificador.
%En el comportamiento fin planificacion se contemplan ambos casos, tanto que el caballero haya muerto en su aventura, en cuyo caso el agente sera eliminado, como que ha tenido éxito. Sino informara con el mensaje rescate del buen hacer de su empresa y el planificador le hara ejecutar el comportamiento convertirse en héroe, que simplemente es informativo. Tras esto, el caballero habra acabadosu planificacion y se borrará.
%Todas las cosas que ocurren se mostrarán en la historia.
Al iniciarse un nuevo héroe, éste cargaba todos sus atributos, registraba el tipo "Matadragones" y se localizaba dentro del mapa.  El héroe registra dos comportamientos principales que son \texttt{OfrecerServicios()} y \texttt{AceptarOfertaRescate()}.

En el comportamiento \texttt{OfrecerServicio()} el héroe espera un mensaje del tipo SolicitarServicio, que mandará el allegado a la víctia cuando quiera que alguien salve a la víctima. A ese mensaje el héroe responderá enviando una propuesta con el precio que cuesta contratar sus servicios, que viene determinado por su codicia (véase el capitulo \ref{cap:AtributosRazas}).

Si esta propuesta es aceptada accederá a su siguiente comportamiento, \texttt{AceptarOfertaRescate}. En este momento le llega una lista de \textit{Strings} que contiene la información necesaria para cumplir el contrato, véase los datos del Secuestrador y de la Víctima que ha de salvar. En ese momento informa con el mensaje \texttt{ObjetivoSecuestro} que emprende la marcha para intentar salvar a la víctima. Tras esto se planifica, donde sus objetivos serán estar con la princesa en su casa y posteriormente convertirse en héroe, para lo que debe volver a la suya propia, que simplemente es informativo.
Tras convertirse en héroe el caballero habrá acabado su planificación y el agente terminará.

También es importante indicar que cada vez que el héroe se mueve por el mapa de una localización a otra, el mundo le pregunta a los antagonistas guardianes y emboscadores si les interesa esta nueva localización. Esto se ve con mas detalle en sus capítulos respectivos.

\subsubsection{El Ayudante del Héroe}

%-------------------------------------------------------------------




\section{Antagonistas}
Para que la historia tuviese sentido siempre debía haber algo que motivase a los protagonistas a emprender sus acciones. Para cumplir este fin surge la figura del Antagonista, un personaje maligno con motivaciones que iban en contra de aquellas que definían la manera de actuar de los protagonistas.

%-------------------------------------------------------------------

\subsection{Diseño de los Antagonistas}
Para diseñar los antagonistas decidimos también que la mejor manera era clasificarlos según las distintas acciones que finalmente serían capaces de realizar, por tanto también decidimos separarlos por clases capaces de separar a nuestros Antagonistas de la misma manera que lo hacíamos con los protagonistas. Las elecciones finales se explican en detalle a continuación:

\subsubsection{El dragón}
El Dragón representa un personaje primordial en la aplicación. Al principio de la historia todo transcurre apaciblemente hasta que el dragón despierta, se inicia el agente, y busca una princesa que pueda secuestrar, en ese momento el dragón decide llevar a cabo el rapto dando a pie a todos los acontecimientos que se suceden después, provocando que el rey avise a los caballeros y estos se muevan a través del mapa, que conforman el nudo de nuestra historia.


%-------------------------------------------------------------------
\subsubsection{Creando nuevos Antagonistas}
Lo primero que tuvimos claro es que, para nosotros, nuevos héroes significaban nuevos antagonistas. Sin embargo, estos nuevos antagonistas no podían ser el mismo antagonista llamado de manera distinta (no nos servía la idea de tener un grifo y un dragón y que los dos hiciesen lo mismo), y de igual manera no queríamos introducir un nuevo tipo de antagonista con la capacidad de suplantar a nuestro dragón como elemento primordial en nuestra historia.

Nuestra primera idea fue la de incluir antagonistas guardianes, es decir, antagonistas que vigilasen un lugar específico del mapa y que castigasen a los aspirantes a héroes que decidiesen atravesar ese camino para completar su aventura. De esta manera, creamos localizaciones concretas y antagonistas específicos para ellas.

La primera localización elegida fue el lago. En el lago podría vivir una serpiente marina, aunque en este caso fuese de agua dulce, que atacase a los aventureros que se atreviesen a cruzarlo, con el objetivo de derrotarlos y que las aguas del lago descansasen tranquilas siempre sin que nada las perturbara.

La segunda localización aprobada fue el cruce. En este cruce de múltiples caminos, un avaricioso trol montaba guardia pidiéndole a los confiados viajeros los tributos necesarios para poder continuar su camino. Los viajeros debían pagar o sino se enfrentarían a la ira del malvado troll.

Como tampoco queríamos que nuestros nuevos antagonistas se limitasen a no dejar pasar a los aspirantes a héroe, decidimos introducir un nuevo antagonista que no interactuase necesariamente con ellos, y así llego el concepto del fantasma.
El fantasma sería el espíritu vengativo de un rey derrocado hace tiempo que no pudo saciar sus ansias de poder. Así su cometido sería vagar por los castillos, buscando aquellos monarcas en los que la desesperación había hecho mella, aumentando su desesperación, lo que implicaba un descenso progresivo en sus puntos de vida.

\subsubsection{Antagonistas genéricos}
Como sucede en otros diseños del proyecto, al tratar de darle un aire mas genérico a nuestros antagonistas decidimos que estos también debían ser configurados por el usuario a través de un archivo XML. Para ello la clasificación de los antagonistas dentro del proyecto cambió, y pasamos a tener antagonistas secuestradores (dragón), emboscadores (trol), guardianes (serpiente) y malignos(fantasma). Esta nueva clasificación haría que los antagonistas trabajasen bajo las condiciones con las que antiguamente estaban diseñados pero que a su vez no tuviesen que ser un antagonista impuesto por nosotros. El esquema final sería algo así:

\begin{table}[h!]
	\centering
	\begin{tabular}{l|l}
		Antagonista					& Objetivo \\ \hline
		Secuestrador				& Secuestrar Princesas \\
		Emboscador 					& Emboscar Héroes a cambio de dinero\\
		Guardian 					& Proteger un Objeto \\
		Maligno						& Atormentar Reyes \\ \hline
	\end{tabular}
	\caption{Tabla final de objetivos y tipos de Monstruos}
	\label{fig:TablaObjetivosMonstruos}
\end{table}

De esta manera el usuario a través del archivo XML, cuya construcción es consultable en \ref{ejemploXML:monstruos}, podría dictaminar el nombre del antagonista, que clase de antagonista dentro de nuestra clasificación específica era, cual era su especie y finalmente cual era su sexo. Así el usuario podría elegir que la princesa fuese secuestrada por el dragón Smaug o por la bruja Maléfica, por poner algunos ejemplos, o de la misma manera, que el dragón Smaug o bien secuestrase princesas en una simulación de la aplicación o bien emboscase a los viajeros que atravesaban cierta localización en otra.
%-------------------------------------------------------------------
\subsection{Implementacion de los Antagonistas}
Para implementar los Antagonistas era necesario tratar con agentes y sus propiedades. A través del agente mundo nuestros agentes se comunicarían con los otros y recibirían la información que necesitaban, pero sin embargo para el correcto funcionamiento de los Antagonistas se necesitaban muchas más cosas.
%-------------------------------------------------------------------
\subsubsection{Carga y configuración de los antagonistas}
Al crear el SCD de Antagonistas, capaz de cargar los datos correctamente del archivo ``Monstruos.XML'' seguimos el patrón preestablecido en el capítulo \ref{cap:Arquitectura:Loaders}, con la particularidad de recorrer los nodos con la palabra clave <monstruo> que contenían los atributos específicos de cada antagonista que queríamos introducir en la historia, los cuales eran almacenados para crear un nuevo agente. El archivo XML seguía mas o menos esta estructura.



\label{ejemploXML:monstruos}
\begin{lstlisting}[basicstyle=\footnotesize, language=xml]
<monstruo 
	nombre ="[nombrePersonaje]" 
	clase ="[Secuestrador|Emboscador|Guardian|Maligno]" 
	especie ="[nombreEspecie]" 
	sexo ="[M|F]"/>
	
Ejemplo:
<monstruo 
	nombre="Smaug" clase="Secuestrador" especie="Dragon" sexo="F"/>

\end{lstlisting}
%<monstruo nombre="Smaug" clase="Secuestrador" especie="Dragon" sexo="F"/>
%<monstruo nombre="Casper" clase="Maligno" especie="Queso Azul Mortifero" sexo="M"/>
%<monstruo nombre="Jormundgander" clase="Guardian" especie="Gyarados" sexo="F"/>
%<monstruo nombre="Trundle" clase="Emboscador" especie="Troll" sexo="M"/>


%-------------------------------------------------------------------
\subsubsection{La Interfaz Antagonistas}
La Interfaz Monstruo era aquella capaz de interpretar correctamente un agente mandado desde el SCD de antagonista. Esta Interfaz a su vez necesitaba de la Interfaz Personaje (ver capítulo \ref{cap:Arquitectura:InterfazPersonajes}), donde conseguía cargar todos los atributos relativos al antagonista, como que era, donde estaba o cuanta vida tenía, y finalmente le dejaba el trabajo a la clase en cuestión que se encargaba de ese tipo antagonistas en específico.
%aquí pondría el diagrama de esta interfaz
A continuación entraremos en detalle a explicar como se implementó cada antagonista en específico.
Para explicar de manera correcta como se comportaban este tipo de antagonistas explicaremos que comportamientos y acciones es capaz de desarrollar como agente.
%-------------------------------------------------------------------

\subsubsection{El Antagonista Secuestrador}
Según se iniciaba el agente secuestrador este solicitaba información al agente Mundo. En este caso el Mundo le tenía que decir cuales eran aquellos agentes que proporcionaban el servicio secuestrables y, en caso de que no hubiese ninguno el agente se quedaba a la espera de que apareciese uno que cumpliese los requisitos solicitados.

En caso de encontrar al menos de los agentes con el servicio secuestrable, escoge entre ellos de manera aleatoria cual será su objetivo, registrando el mensaje ACL "ObjetivoSecuestro". Una vez ha escogido el agente a secuestrar se planifica, incorporando a su funcionamiento los servicios de fallo secuestro, que entraba en acción cuando fallaba en el rapto, y fin de planificación, que se ejecutaba cuando el secuestro se realizaba correctamente.

Cuando se ha producido un error durante el secuestro el agente informará al agente Mundo del mismo, a través de un Message Template, tras lo cual parará su ejecución y volverá al punto inicial, es decir que esperará a que aparezca algún agente secuestrable.

Sin embargo, cuando el secuestro se realiza con éxito, el agente secuestrador ha finalizado correctamente su ejecución. En ese momento informa al agente Mundo y registra el Mensaje ACL "Te secuestro", informando así al agente princesa secuestrado de que en efecto ha sido raptado. Por último, vuelve a su guarida, donde esperará con el agente princesa a que alguien venga a por él y finalmente registrará el comportamiento "HayQueJoderseConLaPrincesita".

Este comportamiento permite al agente princesa secuestrada escaparse de su raptor. Para ello, la princesa ejecutará una tirada aleatoria entre los valores probables de vida de su captor. Cuando el resultado de su tirada sea mayor que la vida actual de éste escapará, lo cual implica que es mucho mas fácil escapar de un captor malherido que de uno que aún conserve todas sus fuerzas.
%-------------------------------------------------------------------
\subsubsection{El Antagonista Emboscador}
El agente emboscador se registraba enviandole al mundo finalmente la información relativa a su tipo, a través de un DFAgentDescription que lo identificaba como "emboscador", tras lo cual registraba los comportamientos de Emboscar y Acecho y finalmente se planificaba.

El comportamiento de Emboscar es bastante complejo. 
Lo primero que debemos contemplar es que el agente emboscador había sido colocado en el mundo gracias al Mapa \ref{cap:Mapa:LocalizacionesAleatoriasSegunClase}, que era la localización donde realizaba sus emboscadas, y que solo emboscaba a personajes de una clase en específico, en este caso cualquier tipo de héroe (caballero, mago o druida).
Tras esta aclaración se explica como funciona el comportamiento de Emboscar.

El agente emboscador le enviaba un mensaje template "SolicitarServicio" al mundo, a la vez que elegían un tipo de clase al cual iban a emboscar. Cada vez que un agente se movía, el mundo busca entre todos los agentes emboscadores, mandandoles la clase que desea cruzar en ese momento.
En caso de que uno, o varios, agentes emboscadores busquen esta clase enviarían una propuesta al mundo junto a su localización. Si la localización de ambos agente no coincidía, no ocurría nada y el agente que se estaba moviendo seguía su camino. Si, sin embargo, la localizacion de ambos agentes era la misma, el mundo aceptaba la propuesta del agente emboscador y le proporcionaba la información del agente que se estaba desplazando por esa localización.

Una vez que la propuesta del agente emboscador ha sido aceptada, da comienzo el comportamiento Acechar, gracias a que dentro de este comportamiento se necesita la respuesta al mensaje cruzar que proporciona el comportamiento anterior.

En el comportamiento Acechar, el emboscador tiene los datos del agente al que esta emboscando, proporcionados por el agente Mundo. De esta manera genera un random con el dinero que le pedirá al otro agente, con el que inicia una conversación con el ID "Hacienda". Si el otro agente tiene el dinero suficiente paga y pasa sin problemas, y sino, el emboscador lo mata.

%-------------------------------------------------------------------
\subsubsection{El Antagonista Guardián}
%Declara su tipo como guardian y se planifica, yendo a buscar un pobjeto aleatorio para custodiarlo. En ese momento espera el encuentro con un caballero y es que, cuando un caballero pase por su guarida, el guardian se enfrentara a el para protegercon recelo su objeto. En ese momento el guardian despertara la actividad del mago que vendra en ayuda del caballero.



%-------------------------------------------------------------------
\subsubsection{El Antagonista Asesino}
%registra su tipo como asesino, añade el comportamiento maldad a partir del cual lanzara el mensaje derrocar, el rey cuya princesa ha sido secuestrada esta debil y es por tanto derrocable, asi que en ese momento el asesino se planifica.


%-------------------------------------------------------------------




\section{PNJ}
\begin{quote}
	\textit{Los PNJ's son personajes del juego que son controlados por el sistema y que son capaces de interactuar con el avatar del jugador intercambiar artículos e información}\cite{GomezGauchiaPeinadoTIDSE06}.
\end{quote}
En el sistema hemos adaptado estos personajes de los juegos a la narrativa para conseguir mayor diversidad de historias generadas.
%-------------------------------------------------------------------

\subsection{Diseño de los PNJ's}
Nuestro numero de historias ya era altamente variado, pero aun así sentíamos que debíamos proponer mas. En busca de un nuevo aire que diese un toque distinto a nuestras historias y aumentase en cantidad el numero posible de estas, propusimos la idea de unos personajes simples, parecidos a los agentes objetos que en un principio queríamos evitar, que con una acción sencilla cambiasen ligeramente el curso de la historia o que sencillamente apareciesen en ella dándole un toque divertido a ésta.

Para ello nos propusimos crear numerosos personajes, que tuviesen como peculiaridad el interactuar con personajes principales cuando éstos pasaban por las localizaciones en las que estaban situados. En ese momento se produciría un pequeño diálogo entre ambos personajes, otorgándole el PNJ un objeto, \ref{cap:Objetos:ObjetosPNJ}, al personaje principal. A este aspecto dentro de la historia lo denominaríamos como ``bufo''. Éste ``bufo'' bien podía ser un objeto que se consumía en el momento o una bendición, que afectaba al personaje modificando sus atributos, ya fuese de manera positiva por que se había encontrado con un PNJ amigable o de manera negativa si éste era perverso. 

Para terminar de definir los PNJ's pensamos que lo que mas encajaba dentro de nuestra propuesta de diseño es que éstos tuviesen un oficio. De esta manera, al crear los PNJ's propusimos que para definir el objeto con el que interactuaban lo suyo era clasificarlos por su oficio, de manera que decidimos que nuestros PNJ's fuesen herreros, enfermeras o sastres, que vivían en los lugares relacionados con su profesión tal y como se comento en el capitulo de mapa\ref{cap:Mapa:LocalizacionesPNJ} vease la herrería, el hospital o la sastrería y proporcionasen este buffo con algo relacionado a su campo, por ejemplo el herrero podría forjar una espada mejor o reestablecer las abolladuras de la armadura del personaje, lo que se acabaría representando como una mejora en un atributo del propio personaje, como puede ser la fuerza con la espada o la vida con la armadura. 
De la misma manera, y para que entendamos el concepto de PNJ malévolo, el personaje podría cruzarse con un chamán, que le da una pócima de setas ''bendecidas por los ancestros´´, donde en ciertas simulaciones aumentaran los atributos del personaje, y en otras los disminuirán.

Sin embargo, decidimos q ue este diseño limitaba a los PNJ's a unos personajes muy específicos con un guión demasiado particular, características que queríamos evitar dentro de nuestra aplicación. De esta forma, decidimos que los PNJ's también pudiesen ser configurables por el usuario a través de ficheros XML que, si se usaban con cuidado, permitirían al usuario personalizar su propia historia.


%-------------------------------------------------------------------
\subsection{Implementación de los PNJ's}
La implementación de los PNJ trajo consigo numerosas adiciones de clases al proyecto. Cada una cumplía con una funcionalidad específica, y eran la mejor solución para cumplir satisfactoriamente el papel de los PNJ's dentro de la aplicación.

\subsubsection{PNJ's configurables por el usuario}
Para permitir la configuración de los PNJ's a través de los XML fue necesario, como de costumbre, un loader capaz de cargar los datos del archivo y almacenarlos correctamente dentro de la aplicación.

Este Loader seguía el diseño normal del resto \ref{cap:Arquitectura:Loaders}, con la particularidad de que cargaba específicamente el fichero ``PNJs.XML'', donde recorría sus nodos buscando la palabra clave <pnj>. Una vez encontrada, recorría el nodo que representaba al propio PNJ almacenando la información referente a su nombre, su sexo, su oficio y su localización, usando esta información para crear un nuevo agente con estas características.
Como con todos los archivos XML, esta configuración exige que el fichero este creado de una manera tan concreta, consultable en \ref{ejemploXML:Pnjs}, por lo tanto se incluyen el fichero ``PNJs.XML'' una guía sobre como construir estos agentes, lo mismo que viene rellenado con una información por defecto que también puede usarse como ejemplo.

\label{ejemploXML:Pnjs}
\begin{lstlisting}[basicstyle=\tiny]
<pnj nombre="[nombrePersonaje]" sexo="[M|F]" oficio="[nombreOficio]" localizacion="[localizacionMapa]"/>

Ejemplo:
<pnj nombre="Thrall" sexo="M" oficio="Chaman" localizacion="Minas"/>
\end{lstlisting}

\subsubsection{La Clase PNJ}
Si bien el agente se iniciaba desde el loader, para poderse cargar de manera correcta necesitaba de una clase capaz de usar correctamente las características específicas de este tipo de agentes. De esta manera se creo la clase PNJ, que heredaba de la interfaz de personajes \ref{cap:Arquitectura:InterfazPersonajes}, que incluía los métodos específicos que permitían el buen funcionamiento de los PNJ's.
