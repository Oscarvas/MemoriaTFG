%---------------------------------------------------------------------
%
%                          Capítulo 5
%
%---------------------------------------------------------------------

\chapter{Diseño e Implementación del Mapa}

\begin{FraseCelebre}
\begin{Frase}
\end{Frase}
\begin{Fuente}
\end{Fuente}
\end{FraseCelebre}

Una buena historia debe contar con un gran mapa. Un gran mapa te permite tener numerosas localizaciones y estas localizaciones enriquecen la historia en la medida de que ocurrirán mas cosas en sitios distintos.

Con este objetivo en mente, decidimos cambiar el antiguo mapa y crear uno nuevo que se adecuase a nuestras necesidades:


\subsection{Un nuevo mapa}
El anterior mapa del TFG era un plano muy sencillo, con apenas 3 localizaciones conectadas entre sí en las que siempre ocurrían las mismas cosas de la misma manera, el dragón iba al castillo, se llevaba a la princesa a la montaña y los caballeros acudían desde el pueblo hasta que finalmente alguno lograba llevarla de vuelta al castillo. 
Para nuestras primeras pruebas lo primero que hicimos fue hacer dudar al planificador, para ver como lidiaba con un problema y trataba de resolverlo, de manera que desconectamos la montaña del pueblo e interpusimos entre el castillo y la montaña dos nuevas localizaciones, el bosque y el lago. Así, si se quería ir del castillo a la montaña, o viceversa, los agentes tenían dos posibles caminos,e incapaces de decidir por ellos mismos, nuestro planificador se encargaría de elegir entre el bosque y el lago de manera aleatoria.
(INSERTAR IMAGEN AQUÍ, mapa con pueblo, castillo, lago bosque y montaña).

La siguiente prueba que le hicimos a nuestro planificador fue saber como escogía las localizaciones por las cuales se moverían nuestros agentes. Tras diversas pruebas probando localizaciones, algunas trampas y unas cuantas horas, descubrimos que el planificador siempre escogía el camino mas corto posible para cada agente, si había dos iguales, elegía indistintamente entre estos e intentaba no repetir con el mismo agente el mismo lugar, es decir, si pasaba con un agente por una localización entre dos posibles a la vuelta elegía la otra.Esto nos permitió conocer en profundidad como actuaba nuestro planificador, y nos daba paso a poder hacer el mapa que realmente queríamos tener.

\subsection{El mapa real}
Cuando nos planteamos el nuevo concepto de mapa decidimos darle un aire fantástico a nuestra historia, así que nos propusimos crear un mundo al viejo estilo de las novelas fantásticas, como las de Tolkien, con nombres específicos que representasen reinos y civilizaciones, para darle un aire mas personal a nuestras posibles historias, buscando un sentido de pertenencia que trata de emular al que debió tener el propio Tolkien al crear su mundo.

Para ello, creamos un archipiélago de islas donde tres islas pequeñas coronaban una isla mayor,  que a su vez se dividía en otras tres partes, dividiendo así nuestro mundo en seis regiones, donde cada cual tenía un numero diferente de localizaciones.

Con el objetivo de que cada región fuese única y no tuviésemos sencillamente seis cachos de tierra con nombres distintos, decidimos proporcionar a cada una un elemento distintivo, que la diferenciase de las demás. 
Así, por ejemplo, decidimos que solo en dos regiones habría castillos, lo cual a su vez limitaba a que solo hubiese dos reinos en nuestro mapa, pues solo en un castillo podría vivir un rey.

De igual manera, habría localizaciones muy especificas en ciertas regiones, por ejemplo en una de ellas estaría la herrería, en otra la taberna, en otra el hospital... Estas localizaciones cumplirían las veces de sitios sencillos que albergan personajes secundarios que pueden cambiar el curso de la historia o sencillamente hacer acto de presencia en el. Así, en estos sitios, aguardarían estos nuevos personajes esperando el momento de su intervención, siendo estos personajes específicos ligados a cada localización, como en este caso serian el herrero, el tabernero o la amable enfermera.

Otra utilidad que le encontramos a la división en regiones fue el ayudarnos a situar a nuestros distintos personajes en el comienzo de la historia. Así asignamos a cada personaje una clase, que les proporcionaban unas características mas especiales, y a cada raza una región natural de la misma. Esto nos facilitaba enormemente el hecho de introducir un nuevo personaje en la historia, pues así un personaje de la raza X aparecería en una localización aleatoria Z situada dentro de la región Y asignada a esta raza X en especifico.

Esta clasificación que unía a las regiones y las razas fue, sin embargo, finalmente descartada.

Para suplirla, decidimos añadir una nueva característica al mapa, concretamente la de tipos de localizaciones.
A través de esta nueva característica, buscamos clasificar nuestras localizaciones según un elemento común, así de todas aquellas localizaciones en el mapa que fuesen bosques sabríamos que lo eran y podríamos interpretarlas correctamente para trabajar con ellas en conjunto. 
De esta manera clasificamos las localizaciones en los siguientes tipos: castillo, pueblo, urbano (que se referían a las localizaciones específicas previamente comentadas como la herrería), bosque, lago, guarida y camino.

Esta clasificación en tipos nos ayudaría a la hora de crear personajes, asignándole a cada clase o monstruo un tipo de localización en concreto, de forma que al crearse dicho personaje fuese situado aleatoriamente en una de las localizaciones que tuviesen el tipo al que dicha clase o monstruo pertenecían. De manera que si a la clase o monstruo X le asignabas el tipo de localización Y, a ese personaje se le cedería una localización específica Z que perteneciese al conjunto de localizaciones del tipo Y.

El orden final nos quedaría así:

\begin{table}[h!]
	\centering
	\begin{tabular}{c|c}
		$Clase o Monstruo$			& $Tipo Localización$ \\ \hline
		Rey 					& Castillo \\
		Princesa 				& Castillo (el del padre) \\
		Caballero 				& Pueblo \\
		Druida 					& Bosque \\
		Mago 					& Urbano \\
		PNJ's 					& Urbano(elección específica) \\
		Monstruo Secuestrador	& Guarida \\
		Monstruo Emboscador 	& Bosque \\
		Monstruo Guardian 		& Lago \\
		Monstruo Maligno		& Cualquiera \\ \hline
	\end{tabular}
\end{table}


Una vez ya habíamos decidido la funcionalidad que tendría nuestro mapa, era el momento de plasmarlo en un mapa virtual, una imagen intuitiva que ayudase al usuario a situarse en la historia. Para ello, dibujamos un primer boceto en papel y procedimos a digitalizarlo, para lo cual usamos la herramienta GIMP.

Una vez correctamente digitalizado, lo introdujimos en la GUI, aportándonos un gran impacto visual y dejándolo listo para usarse.

(INSERTAR IMAGEN AQUÍ, mapa final, con las distintas regiones y todo, impacto visual importante, que se aprecie la mejoría)

Sin embargo, llegado el momento de querer permitir a nuestra historia ser configurada a través de múltiples ficheros XML decidimos que el mapa también debía formar parte de estos elementos configurables. Para ello hubo que cambiarlo totalmente.

Al principio, nuestro mapa no era sino un montón de Strings volcados en un XML. Para cargar correctamente nuestro mapa le dimos a cada localización una matriz de adyacencia con respecto al resto de localizaciones, así, junto a una clase Loader capaz de interpretar correctamente los datos del fichero XML, a través de nuestra clase Mundo, nuestro agente director, se creaba un objeto Mapa con toda la información necesaria relativa a este, que el resto de agentes podían utilizar, y de hecho utilizaban, para conocer sus localizaciones, moverse o saber si compartían la misma localización con otro agente.

Con ánimo de aumentar la capacidad de configuración del mapa le dotamos a cada localización de un tipo, ya fuese bosque, lago, pueblo, que la clasificaba definiendo que tipo de localización era para un uso posterior, a la vez que le dábamos un nombre.

(Insertar imagen aquí, como es el archivo XML del mapa).

